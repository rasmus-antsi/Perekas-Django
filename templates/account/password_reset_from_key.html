{% extends "account/base.html" %}
{% load i18n %}
{% block title %}{% if token_fail %}Vale link{% else %}Määra uus parool{% endif %} | Perekas{% endblock %}
{% block content %}
  <div class="auth-card-minimal">
    <div class="auth-header-minimal">
      <h1>{% if token_fail %}Vale link{% else %}Määra uus parool{% endif %}</h1>
      <p>{% if token_fail %}Parooli taastamise link on vale või aegunud.{% else %}Sisesta uus parool.{% endif %}</p>
    </div>

    {% if token_fail %}
      <div class="auth-content-minimal">
        <p>Parooli taastamise link on vale või on juba kasutatud.</p>
        <div class="auth-actions-minimal">
          <a href="{% url 'account_reset_password' %}" class="landing-button primary">Küsi uus link</a>
        </div>
      </div>
    {% else %}
      <form method="post" action="{{ action_url }}" class="auth-form-minimal">
        {% csrf_token %}
        {% if form.non_field_errors %}
          <div class="auth-error-minimal">{{ form.non_field_errors|join:", " }}</div>
        {% endif %}

        <div class="auth-field-minimal{% if form.password1.errors %} has-error{% endif %}">
          <label for="{{ form.password1.id_for_label }}">{{ form.password1.label }}</label>
          {{ form.password1 }}
          {% for error in form.password1.errors %}
            <span class="auth-field-error-minimal">{{ error }}</span>
          {% endfor %}
        </div>

        <div class="auth-field-minimal{% if form.password2.errors %} has-error{% endif %}">
          <label for="{{ form.password2.id_for_label }}">{{ form.password2.label }}</label>
          {{ form.password2 }}
          {% for error in form.password2.errors %}
            <span class="auth-field-error-minimal">{{ error }}</span>
          {% endfor %}
        </div>

        <div class="auth-actions-minimal">
          <button type="submit" class="landing-button primary">Määra uus parool</button>
        </div>
      </form>

      <p class="auth-switch-minimal">
        <a href="{% url 'account_login' %}">Tagasi sisselogimisele</a>
      </p>
    {% endif %}
  </div>

  <script>
    // Real-time field validation
    function validateField(field) {
      const fieldContainer = field.closest('.auth-field-minimal');
      const errorSpan = fieldContainer.querySelector('.auth-field-error-minimal');
      
      fieldContainer.classList.remove('has-error');
      if (errorSpan) {
        errorSpan.remove();
      }

      let isValid = true;
      let errorMessage = '';

      if (field.hasAttribute('required') && !field.value.trim()) {
        isValid = false;
        errorMessage = 'See väli on kohustuslik.';
      } else if (field.id && field.id.includes('password1') && field.value) {
        if (field.value.length < 8) {
          isValid = false;
          errorMessage = 'Parool peab olema vähemalt 8 tähemärki pikk.';
        }
      } else if (field.id && field.id.includes('password2') && field.value) {
        const password1 = document.getElementById(field.id.replace('password2', 'password1'));
        if (password1 && field.value !== password1.value) {
          isValid = false;
          errorMessage = 'Paroolid ei kattu.';
        }
      }

      if (!isValid) {
        fieldContainer.classList.add('has-error');
        if (errorMessage) {
          const errorEl = document.createElement('span');
          errorEl.className = 'auth-field-error-minimal';
          errorEl.textContent = errorMessage;
          fieldContainer.appendChild(errorEl);
        }
      }

      return isValid;
    }

    document.querySelectorAll('.auth-form-minimal input').forEach(field => {
      if (field.type !== 'hidden' && field.type !== 'submit' && field.type !== 'button') {
        field.addEventListener('blur', function() {
          validateField(this);
        });
        
        // For password confirmation, also validate on password1 change
        if (field.id && field.id.includes('password2')) {
          const password1 = document.getElementById(field.id.replace('password2', 'password1'));
          if (password1) {
            password1.addEventListener('input', function() {
              if (field.value) {
                validateField(field);
              }
            });
          }
        }
      }
    });
  </script>
{% endblock %}

