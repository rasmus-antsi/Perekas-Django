{% extends "account/base.html" %}
{% load i18n %}
{% block title %}Taasta parool | Perekas{% endblock %}
{% block content %}
  <div class="auth-card-minimal">
    <div class="auth-header-minimal">
      <h1>Taasta parool</h1>
      <p>Sisesta oma e-posti aadress ja saadame sulle lingi parooli taastamiseks.</p>
    </div>

    {% if user.is_authenticated %}
      <div class="auth-content-minimal">
        <p>Sa oled juba sisse logitud kui <strong>{{ user.email }}</strong>.</p>
        <div class="auth-actions-minimal">
          <a href="{% url 'a_dashboard:dashboard' %}" class="landing-button primary">Mine töölauale</a>
        </div>
      </div>
    {% else %}
      <form method="post" action="{% url 'account_reset_password' %}" class="auth-form-minimal">
        {% csrf_token %}
        {% if form.non_field_errors %}
          <div class="auth-error-minimal">{{ form.non_field_errors|join:", " }}</div>
        {% endif %}

        <div class="auth-field-minimal{% if form.email.errors %} has-error{% endif %}">
          <label for="{{ form.email.id_for_label }}">{{ form.email.label }}</label>
          {{ form.email }}
          {% for error in form.email.errors %}
            <span class="auth-field-error-minimal">{{ error }}</span>
          {% endfor %}
        </div>

        <div class="auth-actions-minimal">
          <button type="submit" class="landing-button primary">Saada taastamise link</button>
        </div>
      </form>

      <p class="auth-switch-minimal">
        <a href="{% url 'account_login' %}">Tagasi sisselogimisele</a>
      </p>
    {% endif %}
  </div>

  <script>
    // Real-time field validation
    function validateField(field) {
      const fieldContainer = field.closest('.auth-field-minimal');
      const errorSpan = fieldContainer.querySelector('.auth-field-error-minimal');
      
      fieldContainer.classList.remove('has-error');
      if (errorSpan) {
        errorSpan.remove();
      }

      let isValid = true;
      let errorMessage = '';

      if (field.hasAttribute('required') && !field.value.trim()) {
        isValid = false;
        errorMessage = 'See väli on kohustuslik.';
      } else if (field.type === 'email' && field.value) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(field.value)) {
          isValid = false;
          errorMessage = 'Palun sisesta kehtiv e-posti aadress.';
        }
      }

      if (!isValid) {
        fieldContainer.classList.add('has-error');
        if (errorMessage) {
          const errorEl = document.createElement('span');
          errorEl.className = 'auth-field-error-minimal';
          errorEl.textContent = errorMessage;
          fieldContainer.appendChild(errorEl);
        }
      }

      return isValid;
    }

    document.querySelectorAll('.auth-form-minimal input').forEach(field => {
      if (field.type !== 'hidden' && field.type !== 'submit' && field.type !== 'button') {
        field.addEventListener('blur', function() {
          validateField(this);
        });
      }
    });
  </script>
{% endblock %}

