{% extends "a_account/base.html" %}

{% block settings_content %}
  <section class="settings-header">
    <div>
      <h1 class="page-title">Üldine</h1>
      <p class="page-subtitle">Konto- ja profiiliseaded.</p>
    </div>
  </section>

  {% if email_needs_verification and settings_user.email %}
  <div class="email-verification-banner">
    <div class="email-verification-content">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px; flex-shrink: 0;">
        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
        <path d="M9 12l2 2 4-4"></path>
      </svg>
      <div>
        <strong>E-posti aadress vajab kinnitust</strong>
        <p>Sinu e-posti aadress {{ settings_user.email }} pole veel kinnitatud. Palun kontrolli oma e-posti ja kliki kinnituslingil.</p>
      </div>
      <form method="post" action="{% url 'a_family:resend_verification' %}" style="margin-left: auto;">
        {% csrf_token %}
        <input type="hidden" name="email" value="{{ settings_user.email }}">
        <button type="submit" class="btn btn-ghost" style="padding: 0.5rem 1rem; font-size: 0.9rem;">
          Saada uuesti
        </button>
      </form>
    </div>
  </div>
  {% endif %}

  <div class="settings-grid settings-grid-single">
    <section class="settings-card">
      <header class="settings-card-header card-header">
        <div class="card-title-wrap">
          <span class="card-icon icon-purple"></span>
          <div>
            <h2>Profiil ja konto</h2>
            <p>Uuenda oma isikuandmeid ja turvaseadeid.</p>
          </div>
        </div>
      </header>
      <div class="settings-card-body">
        <form method="post" class="settings-form">
          {% csrf_token %}
          <input type="hidden" name="form_type" value="profile">
          <div class="form-grid form-grid-single">
            <label class="form-field">
              <span class="field-label">Kasutajanimi</span>
              <input type="text" name="username" value="{{ settings_user.username|default_if_none:'' }}" placeholder="kasutajanimi" required>
            </label>
            <label class="form-field">
              <span class="field-label">Eesnimi</span>
              <input type="text" name="first_name" value="{{ settings_user.first_name|default_if_none:'' }}" placeholder="Eesnimi" required>
            </label>
            <label class="form-field">
              <span class="field-label">Perekonnanimi</span>
              <input type="text" name="last_name" value="{{ settings_user.last_name|default_if_none:'' }}" placeholder="Perekonnanimi" required>
            </label>
            <label class="form-field">
              <span class="field-label">Sünniaeg</span>
              <input type="date" name="birthdate" value="{% if settings_user.birthdate %}{{ settings_user.birthdate|date:'Y-m-d' }}{% endif %}" max="{{ today|date:'Y-m-d' }}" placeholder="Sünniaeg">
            </label>
            {% if is_parent or settings_user.email %}
            <label class="form-field">
              <span class="field-label">E-posti aadress</span>
              {% if is_parent %}
                <input type="email" name="email" value="{{ settings_user.email|default_if_none:'' }}" placeholder="name@email.com" required>
              {% else %}
                <input type="email" name="email" value="{{ settings_user.email|default_if_none:'' }}" placeholder="name@email.com" disabled>
                <span class="field-hint">Lapsed ei saa oma e-posti aadressi muuta.</span>
              {% endif %}
            </label>
            {% else %}
              <div class="form-field">
                <span class="field-label">E-posti aadress</span>
                <div style="padding: 0.85rem 1rem; border-radius: 0.85rem; border: 1px solid rgba(148, 163, 184, 0.35); background: rgba(15, 23, 42, 0.65); color: rgba(148, 163, 184, 0.7); font-size: 0.98rem;">
                  Lapsel ei ole e-posti aadressi
                </div>
              </div>
            {% endif %}
          </div>
          <label class="form-field">
            <span class="field-label">Roll</span>
            <div class="field-select">
              <select name="role" {% if not is_parent %}disabled{% endif %}>
                <option value="{{ role_parent }}" {% if current_role == role_parent %}selected{% endif %}>Lapsevanem</option>
                <option value="{{ role_child }}" {% if current_role == role_child %}selected{% endif %}>Laps</option>
              </select>
            </div>
            {% if not is_parent %}
              <span class="field-hint">Ainult lapsevanemad saavad rolle muuta.</span>
            {% endif %}
          </label>

          <div class="form-actions">
            <button type="submit" class="btn btn-primary">Salvesta muudatused</button>
            <button type="button" class="btn btn-ghost" id="changePasswordBtn">Muuda parooli</button>
          </div>
        </form>
      </div>
    </section>

    <!-- Transfer Ownership Card (only for family owner with other parents) -->
    {% if is_family_owner and other_parents %}
    <section class="settings-card" style="margin-top: 2rem; border: 1px solid rgba(234, 179, 8, 0.3); background: linear-gradient(135deg, rgba(234, 179, 8, 0.08), rgba(202, 138, 4, 0.05));">
      <div style="display: flex; align-items: center; justify-content: space-between; padding: 1rem 1.5rem; gap: 1.5rem; flex-wrap: wrap;">
        <div style="flex: 1; min-width: 200px;">
          <h3 style="margin: 0 0 0.25rem; font-size: 1.1rem; font-weight: 600; color: rgba(234, 179, 8, 0.95);">Üle kanna omaniku õigused</h3>
          <p style="margin: 0; color: var(--color-text-secondary); font-size: 0.875rem;">Enne konto kustutamist pead üle kandma omaniku õigused teisele lapsevanemale.</p>
        </div>
        <form method="post" action="{% url 'a_account:transfer_ownership' %}" style="margin: 0; flex-shrink: 0; display: flex; align-items: center; gap: 0.75rem;" id="transferOwnershipForm" data-confirm="Kas oled kindel, et soovid omaniku õigused üle kanda? Pärast seda ei saa sa enam pere haldamist.">
          {% csrf_token %}
          <input type="hidden" name="new_owner_id" id="newOwnerId">
          <div style="position: relative;">
            <select id="newOwnerSelect" required style="padding: 0.625rem 1.25rem; padding-right: 2.5rem; border-radius: 0.85rem; border: 1px solid rgba(234, 179, 8, 0.4); background: rgba(234, 179, 8, 0.15); color: rgba(234, 179, 8, 0.95); font-size: 0.875rem; appearance: none; cursor: pointer; white-space: nowrap; min-width: 180px;">
              <option value="">Vali uus omanik...</option>
              {% for parent in other_parents %}
                <option value="{{ parent.id }}">{{ parent.get_display_name }}</option>
              {% endfor %}
            </select>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="position: absolute; right: 0.75rem; top: 50%; transform: translateY(-50%); width: 16px; height: 16px; pointer-events: none; color: rgba(234, 179, 8, 0.7);">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <button type="submit" class="btn" id="transferOwnershipBtn" disabled style="padding: 0.625rem 1.25rem; background: rgba(234, 179, 8, 0.15); border-color: rgba(234, 179, 8, 0.4); color: rgba(234, 179, 8, 0.95); white-space: nowrap; font-size: 0.875rem; opacity: 0.5; cursor: not-allowed;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px; margin-right: 0.5rem;">
              <path d="M17 8l4 4-4 4"></path>
              <path d="M21 12H3"></path>
            </svg>
            Üle kanna
          </button>
        </form>
      </div>
    </section>
    {% endif %}

    <!-- Account Deletion Card (only for parents) -->
    {% if is_parent %}
    <section class="settings-card danger-zone" style="margin-top: 2rem; border: 1px solid rgba(239, 68, 68, 0.3); background: linear-gradient(135deg, rgba(239, 68, 68, 0.08), rgba(220, 38, 38, 0.05));">
      <div style="display: flex; align-items: center; justify-content: space-between; padding: 1rem 1.5rem; gap: 1.5rem;">
        <div style="flex: 1;">
          <h3 style="margin: 0 0 0.25rem; font-size: 1.1rem; font-weight: 600; color: rgba(239, 68, 68, 0.95);">Konto kustutamine</h3>
          <p style="margin: 0; color: var(--color-text-secondary); font-size: 0.875rem;">
            {% if is_family_owner and other_parents %}
              Enne konto kustutamist pead üle kandma omaniku õigused. See kustutab ka pere ja kõik laste kontod.
            {% elif is_family_owner %}
              Konto kustutamine kustutab ka pere ja kõik laste kontod. Seda ei saa tagasi võtta.
            {% else %}
              Konto kustutamine on pöördumatu. Kõik andmed kustutatakse jäädavalt.
            {% endif %}
          </p>
        </div>
        <form method="post" action="{% url 'a_account:delete_account' %}" style="margin: 0; flex-shrink: 0;" data-confirm="{% if is_family_owner %}Kas oled kindel, et soovid oma konto kustutada? See kustutab ka pere ja kõik laste kontod. Seda ei saa tagasi võtta.{% else %}Kas oled kindel, et soovid oma konto kustutada? Seda ei saa tagasi võtta ja kõik sinu andmed kustutatakse jäädavalt.{% endif %}">
          {% csrf_token %}
          <input type="hidden" name="action" value="delete">
          <button type="submit" class="btn" {% if is_family_owner and other_parents %}disabled style="padding: 0.625rem 1.25rem; background: rgba(239, 68, 68, 0.15); border-color: rgba(239, 68, 68, 0.4); color: rgba(239, 68, 68, 0.95); white-space: nowrap; font-size: 0.875rem; opacity: 0.5; cursor: not-allowed;"{% else %}style="padding: 0.625rem 1.25rem; background: rgba(239, 68, 68, 0.15); border-color: rgba(239, 68, 68, 0.4); color: rgba(239, 68, 68, 0.95); white-space: nowrap; font-size: 0.875rem;"{% endif %}>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px; margin-right: 0.5rem;">
              <path d="M3 6h18"></path>
              <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
              <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
            </svg>
            Kustuta konto
          </button>
        </form>
      </div>
    </section>
    {% endif %}

    <!-- Family Deletion Card (only for family owner) -->
    {% if family and family.owner == user %}
    <section class="settings-card danger-zone" style="margin-top: 1rem; border: 1px solid rgba(239, 68, 68, 0.3); background: linear-gradient(135deg, rgba(239, 68, 68, 0.08), rgba(220, 38, 38, 0.05));">
      <div style="display: flex; align-items: center; justify-content: space-between; padding: 1rem 1.5rem; gap: 1.5rem;">
        <div style="flex: 1;">
          <h3 style="margin: 0 0 0.25rem; font-size: 1.1rem; font-weight: 600; color: rgba(239, 68, 68, 0.95);">Pere kustutamine</h3>
          <p style="margin: 0; color: var(--color-text-secondary); font-size: 0.875rem;">Pere kustutamine on pöördumatu. Kõik pere andmed, ülesanded ja ajalugu kustutatakse jäädavalt. Liikmed saavad oma kontot alles hoida.</p>
        </div>
        <form method="post" action="{% url 'a_family:delete_family' %}" style="margin: 0; flex-shrink: 0;" data-confirm="Kas oled kindel, et soovid pere '{{ family.name }}' kustutada? Seda ei saa tagasi võtta. Kõik pere andmed, ülesanded ja ajalugu kustutatakse jäädavalt. Liikmed saavad oma kontot alles hoida.">
          {% csrf_token %}
          <input type="hidden" name="action" value="delete">
          <button type="submit" class="btn" style="padding: 0.625rem 1.25rem; background: rgba(239, 68, 68, 0.15); border-color: rgba(239, 68, 68, 0.4); color: rgba(239, 68, 68, 0.95); white-space: nowrap; font-size: 0.875rem;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px; margin-right: 0.5rem;">
              <path d="M3 6h18"></path>
              <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
              <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
            </svg>
            Kustuta pere
          </button>
        </form>
      </div>
    </section>
    {% endif %}

    <!-- Password Change Modal -->
    <section class="settings-card" id="passwordModal" style="display: none; margin-top: 24px;" aria-hidden="true">
      <header class="settings-card-header card-header">
        <div class="card-title-wrap">
          <span class="card-icon icon-purple"></span>
          <div>
            <h2>Muuda parooli</h2>
            <p>Uuenda oma konto parooli.</p>
          </div>
        </div>
      </header>
      <div class="settings-card-body">
        <form method="post" class="settings-form" id="passwordChangeForm">
          {% csrf_token %}
          <input type="hidden" name="form_type" value="password_change">
          <div class="form-grid form-grid-single">
            <label class="form-field">
              <span class="field-label">Praegune parool</span>
              <input type="password" name="old_password" placeholder="Sisesta praegune parool" required>
            </label>
            <label class="form-field">
              <span class="field-label">Uus parool</span>
              <input type="password" name="new_password1" placeholder="Vähemalt 8 märki, 1 number ja suurtäht" required>
            </label>
            <label class="form-field">
              <span class="field-label">Korda uut parooli</span>
              <input type="password" name="new_password2" placeholder="Korda uut parooli" required>
            </label>
          </div>
          <div class="form-actions">
            <button type="submit" class="btn btn-primary">Muuda parooli</button>
            <button type="button" class="btn btn-ghost" id="hidePasswordBtn">Loobu</button>
          </div>
        </form>
      </div>
    </section>
  </div>

  <!-- Custom Confirmation Modal -->
  <div class="confirm-modal" id="confirm-modal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="confirm-modal-overlay"></div>
    <div class="confirm-modal-content">
      <h3 class="confirm-modal-title" id="confirm-modal-title">Kinnita toiming</h3>
      <p class="confirm-modal-message" id="confirm-modal-message"></p>
      <div class="confirm-modal-actions">
        <button type="button" class="confirm-modal-cancel" id="confirm-modal-cancel">Tühista</button>
        <button type="button" class="confirm-modal-confirm" id="confirm-modal-confirm">Kinnita</button>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_scripts %}
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Transfer ownership form handling
      const transferOwnershipForm = document.getElementById('transferOwnershipForm');
      const newOwnerSelect = document.getElementById('newOwnerSelect');
      const newOwnerIdInput = document.getElementById('newOwnerId');
      const transferOwnershipBtn = document.getElementById('transferOwnershipBtn');
      
      if (transferOwnershipForm && newOwnerSelect && newOwnerIdInput && transferOwnershipBtn) {
        newOwnerSelect.addEventListener('change', function() {
          if (this.value) {
            newOwnerIdInput.value = this.value;
            transferOwnershipBtn.disabled = false;
            transferOwnershipBtn.style.opacity = '1';
            transferOwnershipBtn.style.cursor = 'pointer';
          } else {
            newOwnerIdInput.value = '';
            transferOwnershipBtn.disabled = true;
            transferOwnershipBtn.style.opacity = '0.5';
            transferOwnershipBtn.style.cursor = 'not-allowed';
          }
        });
        
        // Prevent form submission if no owner selected
        transferOwnershipForm.addEventListener('submit', function(e) {
          if (!newOwnerIdInput.value) {
            e.preventDefault();
            return false;
          }
        });
      }
      
      // Password change modal
      const changePasswordBtn = document.getElementById('changePasswordBtn');
      const passwordModal = document.getElementById('passwordModal');
      const passwordChangeForm = document.getElementById('passwordChangeForm');
      const hidePasswordBtn = document.getElementById('hidePasswordBtn');
      
      if (changePasswordBtn && passwordModal) {
        changePasswordBtn.addEventListener('click', function(e) {
          e.preventDefault();
          passwordModal.style.display = 'block';
          passwordModal.setAttribute('aria-hidden', 'false');
          // Scroll to password modal
          setTimeout(() => {
            passwordModal.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 10);
        });
      }
      
      if (hidePasswordBtn && passwordModal) {
        hidePasswordBtn.addEventListener('click', function(e) {
          e.preventDefault();
          passwordModal.style.display = 'none';
          passwordModal.setAttribute('aria-hidden', 'true');
          if (passwordChangeForm) {
            passwordChangeForm.reset();
          }
        });
      }

      // Custom confirmation modal
      const confirmModal = document.getElementById('confirm-modal');
      if (confirmModal) {
        const confirmTitle = document.getElementById('confirm-modal-title');
        const confirmMessage = document.getElementById('confirm-modal-message');
        const confirmButton = document.getElementById('confirm-modal-confirm');
        const cancelButton = document.getElementById('confirm-modal-cancel');
        const confirmOverlay = confirmModal.querySelector('.confirm-modal-overlay');
        
        if (confirmTitle && confirmMessage && confirmButton && cancelButton && confirmOverlay) {
          let confirmResolve = null;
          let pendingForm = null;
          let formSubmitHandler = null;

          function showConfirm(title, message) {
            return new Promise((resolve) => {
              confirmTitle.textContent = title;
              confirmMessage.textContent = message;
              document.body.classList.add('modal-open');
              confirmModal.classList.add('is-visible');
              // Scroll window to top to ensure modal is visible
              setTimeout(() => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
                const modalContent = confirmModal.querySelector('.confirm-modal-content');
                if (modalContent) {
                  modalContent.scrollTop = 0;
                }
              }, 10);
              confirmResolve = resolve;
            });
          }

          function closeConfirm(result) {
            confirmModal.classList.remove('is-visible');
            document.body.classList.remove('modal-open');
            if (confirmResolve) {
              confirmResolve(result);
              confirmResolve = null;
            }
            
            if (result && pendingForm) {
              pendingForm.removeAttribute('data-confirm');
              
              if (formSubmitHandler) {
                pendingForm.removeEventListener('submit', formSubmitHandler);
              }
              
              if (pendingForm.requestSubmit) {
                pendingForm.requestSubmit();
              } else {
                const submitEvent = new Event('submit', {
                  bubbles: true,
                  cancelable: true
                });
                const submitted = pendingForm.dispatchEvent(submitEvent);
                
                if (submitted) {
                  pendingForm.submit();
                }
              }
              
              setTimeout(() => {
                if (pendingForm && formSubmitHandler) {
                  pendingForm.setAttribute('data-confirm', pendingForm.dataset.originalConfirm || '');
                  pendingForm.addEventListener('submit', formSubmitHandler);
                }
              }, 100);
            }
            
            pendingForm = null;
            formSubmitHandler = null;
          }

          confirmButton.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            closeConfirm(true);
          });
          
          cancelButton.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            closeConfirm(false);
          });
          
          confirmOverlay.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            closeConfirm(false);
          });

          document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && confirmModal.classList.contains('is-visible')) {
              closeConfirm(false);
            }
          });

          // Handle forms with data-confirm attribute
          document.querySelectorAll('form[data-confirm]').forEach((form) => {
            form.dataset.originalConfirm = form.getAttribute('data-confirm');
            
            const submitHandler = async function (e) {
              if (!form.hasAttribute('data-confirm')) {
                return;
              }
              
              e.preventDefault();
              e.stopPropagation();
              const message = form.getAttribute('data-confirm');
              const action = form.querySelector('input[name="action"]')?.value || 'toiming';
              let title = 'Kinnita toiming';
              
              if (action === 'delete') {
                title = 'Kinnita kustutamine';
              }
              
              pendingForm = form;
              formSubmitHandler = submitHandler;
              await showConfirm(title, message);
            };
            
            form.addEventListener('submit', submitHandler);
          });
        }
      }
    });
  </script>
{% endblock %}

