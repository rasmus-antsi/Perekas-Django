{% extends "base.html" %}

{% block title %}Ostunimekiri | Perekas{% endblock %}

{% block nav_shopping_active %} active{% endblock %}

{% block content %}
  <div class="page-container">
    <header class="page-header">
      <div>
        <h1 class="page-title">Ostunimekiri</h1>
        <p class="page-subtitle">
          {{ to_buy_count }} eset nimekirjas, {{ in_cart_count }} korvis
        </p>
      </div>
      <button class="pill-button" type="button">{{ family_name }}</button>
    </header>

    <form method="post" class="add-item-card">
      {% csrf_token %}
      <input type="hidden" name="action" value="add">
      <label class="visually-hidden" for="new-item-input">Lisa uus ese</label>
      <input
        id="new-item-input"
        name="name"
        type="text"
        placeholder="Lisa uus ese..."
        {% if not has_family %}disabled{% endif %}
        required
      >
      <button type="submit" class="primary-button" {% if not has_family %}disabled{% endif %}>
        <span aria-hidden="true">+</span>
        <span>Lisa</span>
      </button>
    </form>

    <section class="list-section">
      <header class="list-section-header">
        <span class="list-section-icon need-icon" aria-hidden="true"></span>
        <h2>Vaja osta</h2>
      </header>

      <div class="list-items">
        {% if to_buy_items %}
          {% for item in to_buy_items %}
            <article class="item-card">
              <div>
                <h3 class="item-name">{{ item.name }}</h3>
                <p class="item-meta">Lisas {{ item.added_by.display_name }}</p>
              </div>
              <div class="item-actions">
                <form method="post" class="icon-form">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="toggle">
                  <input type="hidden" name="item_id" value="{{ item.id }}">
                  <input type="hidden" name="set_in_cart" value="true">
                  <button type="submit" class="icon-button success" aria-label="Märgi {{ item.name }} korvis olevaks">
                    <svg viewBox="0 0 24 24" aria-hidden="true">
                      <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                  </button>
                </form>
                <form method="post" class="icon-form" data-confirm="Kas oled kindel, et soovid eseme '{{ item.name }}' kustutada? See toiming on pöördumatu.">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="delete">
                  <input type="hidden" name="item_id" value="{{ item.id }}">
                  <button type="submit" class="icon-button" aria-label="Eemalda {{ item.name }}">
                    <svg viewBox="0 0 24 24" aria-hidden="true">
                      <line x1="18" y1="6" x2="6" y2="18"></line>
                      <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                  </button>
                </form>
              </div>
            </article>
          {% endfor %}
        {% else %}
          <p class="empty-state">Nimekiri on tühi. Lisa esimene ese, et alustada.</p>
        {% endif %}
      </div>
    </section>

    <section class="list-section">
      <header class="list-section-header">
        <span class="list-section-icon cart-icon" aria-hidden="true"></span>
        <h2>Korvis</h2>
      </header>

      <div class="list-items">
        {% if in_cart_items %}
          {% for item in in_cart_items %}
            <article class="item-card in-cart">
              <div>
                <h3 class="item-name">{{ item.name }}</h3>
                <p class="item-meta">Lisas {{ item.added_by.display_name }}</p>
              </div>
              <div class="item-actions">
                <form method="post" class="icon-form">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="toggle">
                  <input type="hidden" name="item_id" value="{{ item.id }}">
                  <input type="hidden" name="set_in_cart" value="false">
                  <button type="submit" class="icon-button success" aria-label="Liiguta {{ item.name }} tagasi nimekirja">
                    <svg viewBox="0 0 24 24" aria-hidden="true">
                      <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path>
                      <path d="M21 3v5h-5"></path>
                      <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path>
                      <path d="M3 21v-5h5"></path>
                    </svg>
                  </button>
                </form>
                <form method="post" class="icon-form" data-confirm="Kas oled kindel, et soovid eseme '{{ item.name }}' kustutada? See toiming on pöördumatu.">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="delete">
                  <input type="hidden" name="item_id" value="{{ item.id }}">
                  <button type="submit" class="icon-button" aria-label="Kustuta {{ item.name }}">
                    <svg viewBox="0 0 24 24" aria-hidden="true">
                      <line x1="18" y1="6" x2="6" y2="18"></line>
                      <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                  </button>
                </form>
              </div>
            </article>
          {% endfor %}
        {% else %}
          <p class="empty-state">Korvis pole veel midagi.</p>
        {% endif %}
      </div>
    </section>
  </div>

  <!-- Custom Confirmation Modal -->
  <div class="confirm-modal" id="confirm-modal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="confirm-modal-overlay"></div>
    <div class="confirm-modal-content">
      <h3 class="confirm-modal-title" id="confirm-modal-title">Kinnita toiming</h3>
      <p class="confirm-modal-message" id="confirm-modal-message"></p>
      <div class="confirm-modal-actions">
        <button type="button" class="confirm-modal-cancel" id="confirm-modal-cancel">Tühista</button>
        <button type="button" class="confirm-modal-confirm" id="confirm-modal-confirm">Kinnita</button>
      </div>
    </div>
  </div>

  <script>
    // Custom confirmation modal - available for all users
    document.addEventListener('DOMContentLoaded', function () {
      const confirmModal = document.getElementById('confirm-modal');
      if (!confirmModal) return;
      
      const confirmTitle = document.getElementById('confirm-modal-title');
      const confirmMessage = document.getElementById('confirm-modal-message');
      const confirmButton = document.getElementById('confirm-modal-confirm');
      const cancelButton = document.getElementById('confirm-modal-cancel');
      const confirmOverlay = confirmModal.querySelector('.confirm-modal-overlay');
      
      if (!confirmTitle || !confirmMessage || !confirmButton || !cancelButton || !confirmOverlay) {
        console.error('Confirmation modal elements not found');
        return;
      }
      
      let confirmResolve = null;
      let pendingForm = null;
      let formSubmitHandler = null;

      function showConfirm(title, message) {
        return new Promise((resolve) => {
          confirmTitle.textContent = title;
          confirmMessage.textContent = message;
          // Prevent body scroll and ensure modal is centered
          document.body.classList.add('modal-open');
          confirmModal.classList.add('is-visible');
          // Ensure modal content is visible by scrolling container to top if needed
          setTimeout(() => {
            confirmModal.scrollTop = 0;
          }, 0);
          confirmResolve = resolve;
        });
      }

      function closeConfirm(result) {
        confirmModal.classList.remove('is-visible');
        document.body.classList.remove('modal-open');
        if (confirmResolve) {
          confirmResolve(result);
          confirmResolve = null;
        }
        
        // If confirmed, submit the pending form
        if (result && pendingForm) {
          // Remove the data-confirm attribute so the form submits normally
          pendingForm.removeAttribute('data-confirm');
          
          // Remove the event listener temporarily
          if (formSubmitHandler) {
            pendingForm.removeEventListener('submit', formSubmitHandler);
          }
          
          // Submit the form directly (this bypasses event listeners)
          if (pendingForm.requestSubmit) {
            // Modern browsers - requestSubmit respects validation but allows submission
            pendingForm.requestSubmit();
          } else {
            // Fallback - create a submit event
            const submitEvent = new Event('submit', {
              bubbles: true,
              cancelable: true
            });
            const submitted = pendingForm.dispatchEvent(submitEvent);
            
            // If event wasn't prevented, submit directly
            if (submitted) {
              pendingForm.submit();
            }
          }
          
          // Re-add the data-confirm attribute and listener after a short delay
          setTimeout(() => {
            if (pendingForm && formSubmitHandler) {
              pendingForm.setAttribute('data-confirm', pendingForm.dataset.originalConfirm || '');
              pendingForm.addEventListener('submit', formSubmitHandler);
            }
          }, 100);
        }
        
        pendingForm = null;
        formSubmitHandler = null;
      }

      confirmButton.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        closeConfirm(true);
      });
      
      cancelButton.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        closeConfirm(false);
      });
      
      confirmOverlay.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        closeConfirm(false);
      });

      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && confirmModal.classList.contains('is-visible')) {
          closeConfirm(false);
        }
      });

      // Handle forms with data-confirm attribute
      document.querySelectorAll('form[data-confirm]').forEach((form) => {
        // Store original confirm message
        form.dataset.originalConfirm = form.getAttribute('data-confirm');
        
        const submitHandler = async function (e) {
          // Skip if form doesn't have data-confirm attribute (means it was removed for submission)
          if (!form.hasAttribute('data-confirm')) {
            return;
          }
          
          e.preventDefault();
          e.stopPropagation();
          const message = form.getAttribute('data-confirm');
          const action = form.querySelector('input[name="action"]')?.value || 'toiming';
          let title = 'Kinnita toiming';
          
          if (action === 'delete') {
            title = 'Kinnita kustutamine';
          }
          
          pendingForm = form;
          formSubmitHandler = submitHandler;
          const confirmed = await showConfirm(title, message);
        };
        
        form.addEventListener('submit', submitHandler);
      });
    });
  </script>
{% endblock %}

