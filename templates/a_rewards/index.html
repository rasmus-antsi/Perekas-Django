{% extends "base.html" %}

{% block title %}Preemiad | Perekas{% endblock %}

{% block nav_rewards_active %} active{% endblock %}

{% block content %}
  <div class="page-container">
    <header class="page-header">
      <div>
        <h1 class="page-title">Preemiapood</h1>
        {% if is_child %}
          <p class="page-subtitle">Sul on kasutada {{ points_balance }} punkti.</p>
        {% elif is_parent %}
          <p class="page-subtitle">Halda pere preemiaid ja jälgi lunastusi.</p>
        {% else %}
          <p class="page-subtitle">Logi sisse või liitu perega, et preemiaid näha.</p>
        {% endif %}
      </div>
      {% if is_parent %}
        <div class="task-toolbar">
          <button type="button" class="primary-button" data-open-reward-modal="create">
            <span aria-hidden="true">+</span>
            <span>Lisa preemia</span>
          </button>
        </div>
      {% endif %}
    </header>

    {% if not has_family %}
      <section class="empty-state">
        <p>Pere pole veel ühendatud. Loo või liitu perega, et preemiaid pakkuda.</p>
      </section>
    {% else %}
      <section class="points-overview-card">
        <div class="points-card-header">
          <div>
            <span class="points-card-label">Sinu punktisaldo</span>
            <h2 class="points-card-value">{{ points_balance }}</h2>
          </div>
          <div class="points-card-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24">
              <path d="M12 2l2.09 6.26H20l-5.18 3.77 1.98 6.09L12 14.76 7.2 18.12 9.18 12 4 8.26h5.91z"></path>
            </svg>
          </div>
        </div>
        <p class="points-card-subtext">Teeni ülesandeid lõpetades punkte ja lunasta need eripreemiateks.</p>
      </section>

      <section class="rewards-section">
        <header class="list-section-header">
          <span class="list-section-icon need-icon" aria-hidden="true"></span>
          <h2>Saadaval preemiad</h2>
        </header>
        <div class="rewards-grid">
          {% if available_rewards %}
            {% for reward in available_rewards %}
              <article class="reward-card">
                <header class="reward-card-header">
                  <div>
                    <h3 class="reward-name">{{ reward.name }}</h3>
                    {% if reward.description %}
                      <p class="reward-description">{{ reward.description }}</p>
                    {% endif %}
                  </div>
                  <span class="reward-points points-chip">
                    <span class="points-value">{{ reward.points }}</span>
                    <span class="points-label">pkt</span>
                  </span>
                </header>
                <div class="reward-actions">
                  {% if reward.can_claim %}
                    <form method="post" class="icon-form" data-confirm="Kas oled kindel, et soovid preemia '{{ reward.name }}' lunastada? See kulutab {{ reward.points }} punkti.">
                      {% csrf_token %}
                      <input type="hidden" name="action" value="claim">
                      <input type="hidden" name="reward_id" value="{{ reward.id }}">
                      <button type="submit" class="primary-button reward-button">
                        <span>Lunasta preemia</span>
                      </button>
                    </form>
                  {% elif is_child %}
                    <button type="button" class="primary-button reward-button" disabled>
                      Vajad veel {{ reward.points_shortfall }} pkt
                    </button>
                  {% else %}
                    <div class="reward-note">Lapsed saavad lunastada, kui neil on piisavalt punkte.</div>
                  {% endif %}
                  {% if is_parent %}
                    <div class="reward-manage">
                      <button
                        type="button"
                        class="icon-button"
                        data-open-reward-modal="edit"
                        data-reward-id="{{ reward.id }}"
                        data-reward-name="{{ reward.name|escape }}"
                        data-reward-description="{{ reward.description|default_if_none:''|escape }}"
                        data-reward-points="{{ reward.points }}"
                      >
                        <svg viewBox="0 0 24 24" aria-hidden="true">
                          <path d="M12 20h9"></path>
                          <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4Z"></path>
                        </svg>
                      </button>
                      <form method="post" class="icon-form" data-confirm="Kas oled kindel, et soovid preemia '{{ reward.name }}' kustutada? See toiming on pöördumatu.">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="delete">
                        <input type="hidden" name="reward_id" value="{{ reward.id }}">
                        <button type="submit" class="icon-button" aria-label="Kustuta {{ reward.name }}">
                          <svg viewBox="0 0 24 24" aria-hidden="true">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                          </svg>
                        </button>
                      </form>
                    </div>
                  {% endif %}
                </div>
              </article>
            {% endfor %}
          {% else %}
            <p class="empty-state full-row">Saadaval preemiaid pole. Lapsevanemad saavad lisada uusi võimalusi.</p>
          {% endif %}
        </div>
      </section>

      <section class="rewards-section">
        <header class="list-section-header">
          <span class="list-section-icon cart-icon" aria-hidden="true"></span>
          <h2>Lunastatud preemiad</h2>
        </header>
        <div class="rewards-grid">
          {% if claimed_rewards %}
            {% for reward in claimed_rewards %}
              <article class="reward-card claimed">
                <header class="reward-card-header">
                  <div>
                    <h3 class="reward-name">{{ reward.name }}</h3>
                    <p class="reward-description">
                      Lunastas {{ reward.claimed_by.display_name }}
                      {% if reward.claimed_at %}
                        {{ reward.claimed_at|date:"j.m.Y H:i" }}
                      {% endif %}
                    </p>
                  </div>
                  <span class="reward-points points-chip">
                    <span class="points-value">{{ reward.points }}</span>
                    <span class="points-label">pkt</span>
                  </span>
                </header>
                {% if is_parent %}
                  <div class="reward-actions">
                    <form method="post" class="icon-form" data-confirm="Kas oled kindel, et soovid preemia '{{ reward.name }}' uuesti kättesaadavaks märkida? See eemaldab lunastuse.">
                      {% csrf_token %}
                      <input type="hidden" name="action" value="unclaim">
                      <input type="hidden" name="reward_id" value="{{ reward.id }}">
                      <button type="submit" class="icon-button" aria-label="Märgi {{ reward.name }} kättesaadavaks">
                        <svg viewBox="0 0 24 24" aria-hidden="true">
                          <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path>
                          <path d="M21 3v5h-5"></path>
                          <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path>
                          <path d="M3 21v-5h5"></path>
                        </svg>
                      </button>
                    </form>
                    <form method="post" class="icon-form" data-confirm="Kas oled kindel, et soovid preemia '{{ reward.name }}' kustutada? See toiming on pöördumatu.">
                      {% csrf_token %}
                      <input type="hidden" name="action" value="delete">
                      <input type="hidden" name="reward_id" value="{{ reward.id }}">
                      <button type="submit" class="icon-button" aria-label="Kustuta {{ reward.name }}">
                        <svg viewBox="0 0 24 24" aria-hidden="true">
                          <line x1="18" y1="6" x2="6" y2="18"></line>
                          <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                      </button>
                    </form>
                  </div>
                {% endif %}
              </article>
            {% endfor %}
          {% else %}
            <p class="empty-state full-row">Ühtegi preemiat pole veel lunastatud. Kasuta oma teenitud punkte!</p>
          {% endif %}
        </div>
      </section>
    {% endif %}
  </div>

  <!-- Custom Confirmation Modal -->
  <div class="confirm-modal" id="confirm-modal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="confirm-modal-overlay"></div>
    <div class="confirm-modal-content">
      <h3 class="confirm-modal-title" id="confirm-modal-title">Kinnita toiming</h3>
      <p class="confirm-modal-message" id="confirm-modal-message"></p>
      <div class="confirm-modal-actions">
        <button type="button" class="confirm-modal-cancel" id="confirm-modal-cancel">Tühista</button>
        <button type="button" class="confirm-modal-confirm" id="confirm-modal-confirm">Kinnita</button>
      </div>
    </div>
  </div>

  {% if is_parent %}
    <div class="task-modal" id="reward-modal" aria-hidden="true" role="dialog" aria-modal="true">
      <div class="task-modal-overlay" data-close-modal></div>
      <div class="task-modal-content">
        <button type="button" class="task-modal-close" data-close-modal aria-label="Sulge preemia vorm">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
        <h2 class="task-modal-title" data-reward-modal-title>Lisa preemia</h2>
        <form method="post" class="task-modal-form" id="reward-modal-form">
          {% csrf_token %}
          <input type="hidden" name="action" value="create">
          <input type="hidden" name="reward_id" value="">
          <label>
            <span>Preemia nimi</span>
            <input type="text" name="name" placeholder="Kinokülastus" required>
          </label>
          <label>
            <span>Kirjeldus</span>
            <textarea name="description" rows="3" placeholder="Lisa lühike kirjeldus"></textarea>
          </label>
          <label>
            <span>Punktikulu</span>
            <input type="number" name="points" min="0" value="100">
          </label>
          <div class="form-actions">
            <button type="submit" class="primary-button">
              <span aria-hidden="true" data-reward-submit-icon>+</span>
              <span data-reward-submit-label>Salvesta preemia</span>
            </button>
          </div>
        </form>
      </div>
    </div>
  {% endif %}

  {% if is_parent %}
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const modal = document.getElementById('reward-modal');
        if (!modal) return;

        const form = document.getElementById('reward-modal-form');
        const actionInput = form.querySelector('input[name="action"]');
        const idInput = form.querySelector('input[name="reward_id"]');
        const nameInput = form.querySelector('input[name="name"]');
        const descriptionInput = form.querySelector('textarea[name="description"]');
        const pointsInput = form.querySelector('input[name="points"]');
        const titleEl = modal.querySelector('[data-reward-modal-title]');
        const submitLabel = modal.querySelector('[data-reward-submit-label]');
        const submitIcon = modal.querySelector('[data-reward-submit-icon]');

        submitIcon.dataset.createIcon = '+';
        submitIcon.dataset.editIcon = '✔';

        function openModal(mode, data = {}) {
          modal.classList.add('is-visible');
          document.body.classList.add('modal-open');
          form.reset();
          // Ensure modal is visible by scrolling viewport to top
          setTimeout(() => {
            window.scrollTo({ top: 0, behavior: 'smooth' });
            const modalContent = modal.querySelector('.task-modal-content');
            if (modalContent) {
              modalContent.scrollTop = 0;
            }
          }, 10);

          if (mode === 'create') {
            actionInput.value = 'create';
            idInput.value = '';
            titleEl.textContent = 'Lisa preemia';
            submitLabel.textContent = 'Salvesta preemia';
            submitIcon.textContent = submitIcon.dataset.createIcon || '+';
            pointsInput.value = 100;
          } else {
            actionInput.value = 'update';
            idInput.value = data.id || '';
            titleEl.textContent = 'Muuda preemiat';
            submitLabel.textContent = 'Uuenda preemiat';
            submitIcon.textContent = submitIcon.dataset.editIcon || '✔';

            nameInput.value = data.name || '';
            descriptionInput.value = data.description || '';
            pointsInput.value = data.points || 0;
          }
        }

        function closeModal() {
          modal.classList.remove('is-visible');
          document.body.classList.remove('modal-open');
        }

        document.querySelectorAll('[data-open-reward-modal="create"]').forEach((button) => {
          button.addEventListener('click', () => openModal('create'));
        });

        document.querySelectorAll('[data-open-reward-modal="edit"]').forEach((button) => {
          button.addEventListener('click', () => {
            openModal('edit', {
              id: button.dataset.rewardId,
              name: button.dataset.rewardName,
              description: button.dataset.rewardDescription,
              points: button.dataset.rewardPoints,
            });
          });
        });

        modal.querySelectorAll('[data-close-modal]').forEach((el) => {
          el.addEventListener('click', closeModal);
        });

        modal.addEventListener('click', (event) => {
          if (event.target === modal) {
            closeModal();
          }
        });

        document.addEventListener('keydown', (event) => {
          if (event.key === 'Escape' && modal.classList.contains('is-visible')) {
            closeModal();
          }
        });
      });
    </script>
  {% endif %}

  <script>
    // Custom confirmation modal - available for all users
    document.addEventListener('DOMContentLoaded', function () {
      const confirmModal = document.getElementById('confirm-modal');
      if (!confirmModal) return;
      
      const confirmTitle = document.getElementById('confirm-modal-title');
      const confirmMessage = document.getElementById('confirm-modal-message');
      const confirmButton = document.getElementById('confirm-modal-confirm');
      const cancelButton = document.getElementById('confirm-modal-cancel');
      const confirmOverlay = confirmModal.querySelector('.confirm-modal-overlay');
      
      if (!confirmTitle || !confirmMessage || !confirmButton || !cancelButton || !confirmOverlay) {
        console.error('Confirmation modal elements not found');
        return;
      }
      
      let confirmResolve = null;
      let pendingForm = null;
      let formSubmitHandler = null;

      function showConfirm(title, message) {
        return new Promise((resolve) => {
          confirmTitle.textContent = title;
          confirmMessage.textContent = message;
          // Prevent body scroll and ensure modal is visible
          document.body.classList.add('modal-open');
          confirmModal.classList.add('is-visible');
          // Scroll window to top to ensure modal is visible
          setTimeout(() => {
            window.scrollTo({ top: 0, behavior: 'smooth' });
            const modalContent = confirmModal.querySelector('.confirm-modal-content');
            if (modalContent) {
              modalContent.scrollTop = 0;
            }
          }, 10);
          confirmResolve = resolve;
        });
      }

      function closeConfirm(result) {
        confirmModal.classList.remove('is-visible');
        document.body.classList.remove('modal-open');
        if (confirmResolve) {
          confirmResolve(result);
          confirmResolve = null;
        }
        
        // If confirmed, submit the pending form
        if (result && pendingForm) {
          // Remove the data-confirm attribute so the form submits normally
          pendingForm.removeAttribute('data-confirm');
          
          // Remove the event listener temporarily
          if (formSubmitHandler) {
            pendingForm.removeEventListener('submit', formSubmitHandler);
          }
          
          // Submit the form directly (this bypasses event listeners)
          if (pendingForm.requestSubmit) {
            // Modern browsers - requestSubmit respects validation but allows submission
            pendingForm.requestSubmit();
          } else {
            // Fallback - create a submit event
            const submitEvent = new Event('submit', {
              bubbles: true,
              cancelable: true
            });
            const submitted = pendingForm.dispatchEvent(submitEvent);
            
            // If event wasn't prevented, submit directly
            if (submitted) {
              pendingForm.submit();
            }
          }
          
          // Re-add the data-confirm attribute and listener after a short delay
          setTimeout(() => {
            if (pendingForm && formSubmitHandler) {
              pendingForm.setAttribute('data-confirm', pendingForm.dataset.originalConfirm || '');
              pendingForm.addEventListener('submit', formSubmitHandler);
            }
          }, 100);
        }
        
        pendingForm = null;
        formSubmitHandler = null;
      }

      confirmButton.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        closeConfirm(true);
      });
      
      cancelButton.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        closeConfirm(false);
      });
      
      confirmOverlay.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        closeConfirm(false);
      });

      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && confirmModal.classList.contains('is-visible')) {
          closeConfirm(false);
        }
      });

      // Handle forms with data-confirm attribute
      document.querySelectorAll('form[data-confirm]').forEach((form) => {
        // Store original confirm message
        form.dataset.originalConfirm = form.getAttribute('data-confirm');
        
        const submitHandler = async function (e) {
          // Skip if form doesn't have data-confirm attribute (means it was removed for submission)
          if (!form.hasAttribute('data-confirm')) {
            return;
          }
          
          e.preventDefault();
          e.stopPropagation();
          const message = form.getAttribute('data-confirm');
          const action = form.querySelector('input[name="action"]')?.value || 'toiming';
          let title = 'Kinnita toiming';
          
          if (action === 'delete') {
            title = 'Kinnita kustutamine';
          } else if (action === 'claim') {
            title = 'Kinnita lunastamine';
          } else if (action === 'unclaim') {
            title = 'Kinnita tagasivõtmine';
          }
          
          pendingForm = form;
          formSubmitHandler = submitHandler;
          const confirmed = await showConfirm(title, message);
        };
        
        form.addEventListener('submit', submitHandler);
      });
    });
  </script>
{% endblock %}

