{% extends "base.html" %}

{% block title %}Töölaud | Perekas{% endblock %}

{% block nav_dashboard_active %} active{% endblock %}

{% block content %}
  <div class="page-container dashboard-page">
    <section class="dashboard-header">
      <div>
        <h1 class="page-title">Tere tulemast tagasi, {{ request.user.display_name }}!</h1>
        <p class="page-subtitle">Siin on teie pere tänane ülevaade.</p>
      </div>
    </section>

    {% if not family %}
      <section class="empty-state full-row">
        <p>Pereprofiili ei leitud. Looge uus pere või liituge olemasolevaga, et näha jagatud tegevust.</p>
      </section>
    {% elif role_view == 'child' %}
      {% if child_context %}
        <section class="stats-grid">
          <article class="stat-card">
            <div class="stat-card-icon icon-purple">
              <svg viewBox="0 0 24 24">
                <path d="M4 4h16v6H4z"></path>
                <path d="M4 14h10v6H4z"></path>
                <path d="M16 14h4v6h-4z"></path>
              </svg>
            </div>
            <div class="stat-card-body">
              <span class="stat-label">Tänased ülesanded</span>
              <div class="stat-value">{{ child_context.today_tasks|length }}</div>
              <div class="stat-change">{{ child_context.pending_reviews|length }} ootab kinnitamist</div>
            </div>
          </article>
          <article class="stat-card">
            <div class="stat-card-icon icon-green">
              <svg viewBox="0 0 24 24">
                <path d="M12 3v18"></path>
                <path d="M5 12h14"></path>
              </svg>
            </div>
            <div class="stat-card-body">
              <span class="stat-label">Sinu punktid</span>
              <div class="stat-value">{{ child_context.points_total }}</div>
              <div class="stat-change">+{{ child_context.points_week }} sel nädalal</div>
            </div>
          </article>
          <article class="stat-card">
            <div class="stat-card-icon icon-orange">
              <svg viewBox="0 0 24 24">
                <path d="M12 2l1.5 4.5H18l-3.75 2.7L15.75 14 12 11.4 8.25 14l1.5-4.8L6 6.5h4.5z"></path>
              </svg>
            </div>
            <div class="stat-card-body">
              <span class="stat-label">Saadaval preemiad</span>
              <div class="stat-value">{{ child_context.rewards_available|length }}</div>
              <div class="stat-change">
                {% if child_context.next_reward %}
                  Vaja veel {{ child_context.points_needed }} punkti
                {% else %}
                  Vali uus eesmärk
                {% endif %}
              </div>
            </div>
          </article>
          <article class="stat-card">
            <div class="stat-card-icon icon-teal">
              <svg viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
              </svg>
            </div>
            <div class="stat-card-body">
              <span class="stat-label">Tulekul</span>
              <div class="stat-value">{{ child_context.upcoming_tasks|length }}</div>
              <div class="stat-change">Järgmised tähtajad lähiajal</div>
            </div>
          </article>
        </section>

        <section class="dashboard-grid child-dashboard-main">
          <article class="recent-card">
            <header class="card-header">
              <div class="card-title-wrap">
                <span class="card-icon icon-green"></span>
                <h2>Tänased ülesanded</h2>
              </div>
              <a href="{% url 'a_tasks:index' %}" class="card-link">Halda ülesandeid →</a>
            </header>
            {% if child_context.today_tasks %}
              <ul class="recent-task-list">
                {% for task in child_context.today_tasks %}
                  <li class="recent-task">
                    <div class="recent-task-info">
                      <h3>{{ task.name }}</h3>
                      <p>{{ task.points }} punkti{% if task.due_date %} · Tähtaeg {{ task.due_date|date:"d.m" }}{% endif %}</p>
                    </div>
                    <span class="recent-task-points">Tee ära</span>
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <p class="empty-state full-row">Sul pole täna ühtegi ülesannet.</p>
            {% endif %}
          </article>

          <article class="recent-card">
            <header class="card-header">
              <div class="card-title-wrap">
                <span class="card-icon icon-orange"></span>
                <h2>Preemiad</h2>
              </div>
              <a href="{% url 'a_rewards:index' %}" class="card-link">Vaata preemiaid →</a>
            </header>
            {% if child_context.rewards_available %}
              <ul class="recent-task-list">
                {% for reward in child_context.rewards_available %}
                  <li class="recent-task">
                    <div class="recent-task-info">
                      <h3>{{ reward.name }}</h3>
                      <p>{{ reward.points }} punkti</p>
                    </div>
                    {% if reward.is_goal %}
                      <span class="recent-task-points">Eesmärk</span>
                    {% elif reward.available_now %}
                      <span class="recent-task-points">Saadaval</span>
                    {% else %}
                      <span class="recent-task-points">{{ reward.shortfall }} puudu</span>
                    {% endif %}
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <p class="empty-state full-row">Pere pole veel preemiaid lisanud.</p>
            {% endif %}
          </article>
        </section>

        <section class="dashboard-grid child-dashboard-secondary">
          <article class="members-card">
            <header class="card-header">
              <div class="card-title-wrap">
                <span class="card-icon icon-purple"></span>
                <h2>Hiljutine aktiivsus</h2>
              </div>
            </header>
            {% if child_context.recent_activity %}
              <ul class="recent-task-list">
                {% for activity in child_context.recent_activity %}
                  <li class="recent-task">
                    <div class="recent-task-info">
                      <h3>{{ activity.name }}</h3>
                      <p>{% if activity.approved %}Kinnitatud{% else %}Ootab kinnitust{% endif %} · {{ activity.points }} punkti</p>
                    </div>
                    <span class="recent-task-points">{{ activity.completed_at|timesince }} tagasi</span>
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <p class="empty-state full-row">Su tegevused ilmuvad siia, kui ülesandeid täidad.</p>
            {% endif %}
          </article>

          <article class="recent-card">
            <header class="card-header">
              <div class="card-title-wrap">
                <span class="card-icon icon-teal"></span>
                <h2>Kiirtoimingud</h2>
              </div>
            </header>
            <div class="quick-actions-inline">
              {% for action in child_context.quick_actions %}
                <a href="{% url action.url %}" class="quick-action-inline">
                  <div class="quick-icon quick-{{ action.icon }}"></div>
                  <div>
                    <h3>{{ action.label }}</h3>
                    <p>{{ action.description }}</p>
                  </div>
                </a>
              {% endfor %}
            </div>
          </article>
        </section>
      {% else %}
        <section class="empty-state full-row">
          <p>Hetkel pole sinu jaoks andmeid näidata. Palu vanemal ülesandeid lisada.</p>
        </section>
      {% endif %}
    {% else %}
      {% if parent_stat_cards %}
      <section class="stats-grid">
        {% for card in parent_stat_cards %}
          <a class="stat-card-link" href="{% url card.url %}">
            <article class="stat-card">
              <div class="stat-card-icon {{ card.icon }}">
                <svg viewBox="0 0 24 24">
                  <path d="M4 4h16v6H4z"></path>
                  <path d="M4 14h10v6H4z"></path>
                  <path d="M16 14h4v6h-4z"></path>
                </svg>
              </div>
              <div class="stat-card-body">
                <span class="stat-label">{{ card.label }}</span>
                <div class="stat-value">{{ card.value }}</div>
                <div class="stat-change">{{ card.change }}</div>
              </div>
            </article>
          </a>
        {% endfor %}
      </section>
      {% endif %}

      <section class="dashboard-grid">
        <article class="members-card">
          <header class="card-header">
            <div class="card-title-wrap">
              <span class="card-icon icon-purple"></span>
              <h2>Pere liikmed</h2>
            </div>
          </header>
          {% if family_members %}
            <div class="members-grid">
              {% for member in family_members %}
                <div class="member-card">
                  <div class="member-header">
                    <div class="member-avatar">{{ member.initials }}</div>
                    <div class="member-info">
                      <h3>{{ member.name }}</h3>
                      <p>
                        {% if member.role == 'Lapsevanem' %}
                          Lapsevanem
                        {% else %}
                          {{ member.points }} punkti
                        {% endif %}
                      </p>
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <p class="empty-state full-row">Pereliikmeid pole veel laaditud.</p>
          {% endif %}
        </article>

        <article class="recent-card">
          <header class="card-header">
            <div class="card-title-wrap">
              <span class="card-icon icon-green"></span>
              <h2>Viimased ülesanded</h2>
            </div>
            <a href="{% url 'a_tasks:index' %}" class="card-link">Vaata kõiki ülesandeid →</a>
          </header>
          {% if recent_tasks %}
            <ul class="recent-task-list">
              {% for task in recent_tasks %}
                <li class="recent-task">
                  <div class="recent-task-info">
                    <h3>{{ task.name }}</h3>
                    <p>
                      {{ task.completed_by.display_name }}
                      · {{ task.completed_at|timesince }} tagasi
                    </p>
                  </div>
                  <span class="recent-task-points">{{ task.points }} punkti</span>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="empty-state full-row">Hiljutisi ülesandeid pole.</p>
          {% endif %}
        </article>
      </section>

      <section class="quick-actions">
        <h2>Kiirtoimingud</h2>
        <div class="quick-grid">
          {% for action in quick_actions %}
            <a href="{% url action.url %}" class="quick-card">
              <div class="quick-icon quick-{{ action.icon }}"></div>
              <h3>{{ action.label }}</h3>
              <p>{{ action.description }}</p>
            </a>
          {% endfor %}
        </div>
      </section>
    {% endif %}
  </div>
{% endblock %}