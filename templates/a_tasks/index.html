{% extends "base.html" %}

{% block title %}Ülesanded | Perekas{% endblock %}

{% block nav_tasks_active %} active{% endblock %}

{% block content %}
  <div class="page-container">
    <header class="page-header">
      <div>
        <h1 class="page-title">Ülesanded</h1>
        {% if has_family %}
          <p class="page-subtitle">
            Korralda koduseid tegemisi, jälgi punkte ja tähista väikeseid võite.
          </p>
        {% else %}
          <p class="page-subtitle">Loo või liitu perega, et hakata ülesandeid jagama.</p>
        {% endif %}
      </div>
      {% if is_parent %}
        <div class="task-toolbar">
          <button type="button" class="primary-button" data-open-task-modal="create">
            <span aria-hidden="true">+</span>
            <span>Lisa ülesanne</span>
          </button>
        </div>
      {% endif %}
    </header>

    {% if not has_family %}
      <section class="empty-state">
        <p>Perekonda pole veel ühendatud. Kui lood või liitud perega, saad hakata ülesandeid haldama.</p>
      </section>
    {% else %}
      <section class="task-section">
        <header class="list-section-header">
          <span class="list-section-icon need-icon" aria-hidden="true"></span>
          <h2>Aktiivsed ülesanded</h2>
        </header>
        <div class="task-grid">
          {% if active_tasks %}
            {% for task in active_tasks %}
              <article class="task-card priority-{{ task.priority }}">
                <div class="task-card-header">
                  <div>
                    <h3 class="task-name">{{ task.name }}</h3>
                    <p class="task-assigned">
                      {% if is_child %}
                        {% if task.assigned_to == user %}
                          Määratud: Sinule
                        {% elif task.assigned_to %}
                          {{ task.assigned_to.get_full_name|default:task.assigned_to.username }}
                        {% else %}
                          Määratud: Kõikile
                        {% endif %}
                      {% else %}
                        {% if task.assigned_to %}
                          Määratud: {{ task.assigned_to.get_full_name|default:task.assigned_to.username }}
                        {% else %}
                          Määratud: Kõikile
                        {% endif %}
                      {% endif %}
                    </p>
                    {% if task.description %}
                      <p class="task-description">{{ task.description }}</p>
                    {% endif %}
                  </div>
                  <span class="task-points points-chip">
                    <span class="points-value">{{ task.points }}</span>
                    <span class="points-label">pkt</span>
                  </span>
                </div>
                <div class="task-meta">
                  <div class="task-meta-item">
                    <svg class="task-meta-icon" viewBox="0 0 24 24" aria-hidden="true">
                      <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
                    </svg>
                    <span class="task-meta-label">{% if task.priority == 0 %}Madal{% elif task.priority == 1 %}Keskmine{% else %}Kõrge{% endif %}</span>
                  </div>
                  {% if task.due_date %}
                    <div class="task-meta-item">
                      <svg class="task-meta-icon" viewBox="0 0 24 24" aria-hidden="true">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                      </svg>
                      <span class="task-meta-label">{{ task.due_date|date:"j.m" }}</span>
                    </div>
                  {% endif %}
                </div>
                <div class="task-actions">
                  {% if task.can_child_complete %}
                    <form method="post" class="icon-form" data-confirm="Kas oled kindel, et soovid ülesande '{{ task.name }}' täita? See märgib ülesande lõpetatuks ja ootab kinnitust.">
                      {% csrf_token %}
                      <input type="hidden" name="action" value="complete">
                      <input type="hidden" name="task_id" value="{{ task.id }}">
                      <button type="submit" class="icon-button success" aria-label="Märgi {{ task.name }} tehtuks">
                        <svg viewBox="0 0 24 24" aria-hidden="true">
                          <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                      </button>
                    </form>
                  {% endif %}
                  {% if is_parent %}
                    <button
                      type="button"
                      class="icon-button"
                      data-open-task-modal="edit"
                      data-task-id="{{ task.id }}"
                      data-task-name="{{ task.name|escape }}"
                      data-task-description="{{ task.description|default_if_none:''|escape }}"
                      data-task-assigned="{{ task.assigned_to_id|default:'' }}"
                      data-task-points="{{ task.points }}"
                      data-task-priority="{{ task.priority }}"
                      data-task-due="{{ task.due_date|date:'Y-m-d'|default_if_none:'' }}"
                    >
                      <svg viewBox="0 0 24 24" aria-hidden="true">
                        <path d="M12 20h9"></path>
                        <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4Z"></path>
                      </svg>
                    </button>
                    <form method="post" class="icon-form" data-confirm="Kas oled kindel, et soovid ülesande '{{ task.name }}' kustutada? See toiming on pöördumatu.">
                      {% csrf_token %}
                      <input type="hidden" name="action" value="delete">
                      <input type="hidden" name="task_id" value="{{ task.id }}">
                      <button type="submit" class="icon-button" aria-label="Kustuta {{ task.name }}">
                        <svg viewBox="0 0 24 24" aria-hidden="true">
                          <polyline points="3 6 5 6 21 6"></polyline>
                          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                          <line x1="10" y1="11" x2="10" y2="17"></line>
                          <line x1="14" y1="11" x2="14" y2="17"></line>
                        </svg>
                      </button>
                    </form>
                  {% endif %}
                </div>
              </article>
            {% endfor %}
          {% else %}
            <p class="empty-state full-row">Aktiivseid ülesandeid pole. Võta hetk puhkuseks!</p>
          {% endif %}
        </div>
      </section>

      <section class="task-section">
        <header class="list-section-header">
          <span class="list-section-icon accent-icon" aria-hidden="true"></span>
          <h2>Ootab kinnitust</h2>
        </header>
        <div class="task-grid">
          {% if pending_tasks %}
            {% for task in pending_tasks %}
              <article class="task-card awaiting priority-{{ task.priority }}">
                <div class="task-card-header">
                  <div>
                    <h3 class="task-name">{{ task.name }}</h3>
                    <p class="task-assigned">
                      {% if is_child %}
                        {% if task.assigned_to == user %}
                          Määratud: Sinule
                        {% elif task.assigned_to %}
                          {{ task.assigned_to.get_full_name|default:task.assigned_to.username }}
                        {% else %}
                          Määratud: Kõikile
                        {% endif %}
                      {% else %}
                        {% if task.assigned_to %}
                          Määratud: {{ task.assigned_to.get_full_name|default:task.assigned_to.username }}
                        {% else %}
                          Määratud: Kõikile
                        {% endif %}
                      {% endif %}
                    </p>
                    {% if task.description %}
                      <p class="task-description">{{ task.description }}</p>
                    {% endif %}
                  </div>
                  <span class="task-points points-chip">
                    <span class="points-value">{{ task.points }}</span>
                    <span class="points-label">pts</span>
                  </span>
                </div>
                <div class="task-meta">
                  <div class="task-meta-item">
                    <svg class="task-meta-icon" viewBox="0 0 24 24" aria-hidden="true">
                      <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
                    </svg>
                    <span class="task-meta-label">{% if task.priority == 0 %}Madal{% elif task.priority == 1 %}Keskmine{% else %}Kõrge{% endif %}</span>
                  </div>
                  <div class="task-meta-item">
                    <svg class="task-meta-icon" viewBox="0 0 24 24" aria-hidden="true">
                      <circle cx="12" cy="12" r="10"></circle>
                      <polyline points="12 6 12 12 16 14"></polyline>
                    </svg>
                    <span class="task-meta-label">Lõpetas {{ task.completed_by.get_full_name|default:task.completed_by.username }} {{ task.completed_at|date:"j.m.Y H:i" }}</span>
                  </div>
                  {% if task.due_date %}
                    <div class="task-meta-item">
                      <svg class="task-meta-icon" viewBox="0 0 24 24" aria-hidden="true">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                      </svg>
                      <span class="task-meta-label">{{ task.due_date|date:"j.m" }}</span>
                    </div>
                  {% endif %}
                </div>
                <div class="task-actions">
                  {% if is_parent %}
                    <form method="post" class="icon-form" data-confirm="Kas oled kindel, et soovid ülesande '{{ task.name }}' kinnitada? See annab {{ task.points }} punkti ja märgib ülesande kinnitatud.">
                      {% csrf_token %}
                      <input type="hidden" name="action" value="approve">
                      <input type="hidden" name="task_id" value="{{ task.id }}">
                      <button type="submit" class="icon-button success" aria-label="Kinnita {{ task.name }}">
                        <svg viewBox="0 0 24 24" aria-hidden="true">
                          <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                      </button>
                    </form>
                    <form method="post" class="icon-form" data-confirm="Kas oled kindel, et soovid ülesande '{{ task.name }}' uuesti avada? See eemaldab täitmise staatuse.">
                      {% csrf_token %}
                      <input type="hidden" name="action" value="reopen">
                      <input type="hidden" name="task_id" value="{{ task.id }}">
                      <button type="submit" class="icon-button" aria-label="Ava {{ task.name }} uuesti">
                        <svg viewBox="0 0 24 24" aria-hidden="true">
                          <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path>
                          <path d="M21 3v5h-5"></path>
                          <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path>
                          <path d="M3 21v-5h5"></path>
                        </svg>
                      </button>
                    </form>
                  {% endif %}
                </div>
              </article>
            {% endfor %}
          {% else %}
            <p class="empty-state full-row">Kinnitust ootavaid ülesandeid pole.</p>
          {% endif %}
        </div>
      </section>

      <section class="task-section">
        <header class="list-section-header">
          <span class="list-section-icon cart-icon" aria-hidden="true"></span>
          <h2>Kinnitatud ülesanded</h2>
        </header>
        <div class="task-grid">
          {% if approved_tasks %}
            {% for task in approved_tasks %}
              <article class="task-card approved priority-{{ task.priority }}">
                <div class="task-card-header">
                  <div>
                    <h3 class="task-name">{{ task.name }}</h3>
                    <p class="task-assigned">
                      {% with winner=task.assigned_to|default:task.completed_by %}
                        {% if is_child %}
                          {% if winner == user %}
                            Punktid teenis: Sina
                          {% else %}
                            Punktid teenis: {{ winner.get_full_name|default:winner.username }}
                          {% endif %}
                        {% else %}
                          Punktid teenis: {{ winner.get_full_name|default:winner.username }}
                        {% endif %}
                      {% endwith %}
                    </p>
                    {% if task.description %}
                      <p class="task-description">{{ task.description }}</p>
                    {% endif %}
                  </div>
                  <span class="task-points points-chip">
                    <span class="points-value">{{ task.points }}</span>
                    <span class="points-label">pts</span>
                  </span>
                </div>
                <div class="task-meta">
                  <div class="task-meta-item">
                    <svg class="task-meta-icon" viewBox="0 0 24 24" aria-hidden="true">
                      <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
                    </svg>
                    <span class="task-meta-label">{% if task.priority == 0 %}Madal{% elif task.priority == 1 %}Keskmine{% else %}Kõrge{% endif %}</span>
                  </div>
                  <div class="task-meta-item">
                    <svg class="task-meta-icon" viewBox="0 0 24 24" aria-hidden="true">
                      <circle cx="12" cy="12" r="10"></circle>
                      <polyline points="12 6 12 12 16 14"></polyline>
                    </svg>
                    <span class="task-meta-label">Kinnitas {{ task.approved_by.get_full_name|default:task.approved_by.username }} {{ task.approved_at|date:"j.m.Y H:i" }}</span>
                  </div>
                  {% if task.due_date %}
                    <div class="task-meta-item">
                      <svg class="task-meta-icon" viewBox="0 0 24 24" aria-hidden="true">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                      </svg>
                      <span class="task-meta-label">{{ task.due_date|date:"j.m" }}</span>
                    </div>
                  {% endif %}
                </div>
                {% if is_parent %}
                  <div class="task-actions">
                    <form method="post" class="icon-form" data-confirm="Kas oled kindel, et soovid ülesande '{{ task.name }}' kustutada? See toiming on pöördumatu.">
                      {% csrf_token %}
                      <input type="hidden" name="action" value="delete">
                      <input type="hidden" name="task_id" value="{{ task.id }}">
                      <button type="submit" class="icon-button" aria-label="Kustuta {{ task.name }}">
                        <svg viewBox="0 0 24 24" aria-hidden="true">
                          <polyline points="3 6 5 6 21 6"></polyline>
                          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                          <line x1="10" y1="11" x2="10" y2="17"></line>
                          <line x1="14" y1="11" x2="14" y2="17"></line>
                        </svg>
                      </button>
                    </form>
                  </div>
                {% endif %}
              </article>
            {% endfor %}
          {% else %}
            <p class="empty-state full-row">Kinnitatud ülesandeid veel pole. Jätkake samas vaimus!</p>
          {% endif %}
        </div>
      </section>
    {% endif %}
  </div>

  <!-- Custom Confirmation Modal -->
  <div class="confirm-modal" id="confirm-modal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="confirm-modal-overlay"></div>
    <div class="confirm-modal-content">
      <h3 class="confirm-modal-title" id="confirm-modal-title">Kinnita toiming</h3>
      <p class="confirm-modal-message" id="confirm-modal-message"></p>
      <div class="confirm-modal-actions">
        <button type="button" class="confirm-modal-cancel" id="confirm-modal-cancel">Tühista</button>
        <button type="button" class="confirm-modal-confirm" id="confirm-modal-confirm">Kinnita</button>
      </div>
    </div>
  </div>

  {% if is_parent %}
    <div class="task-modal" id="task-modal" aria-hidden="true" role="dialog" aria-modal="true">
      <div class="task-modal-overlay" data-close-modal></div>
      <div class="task-modal-content">
        <button type="button" class="task-modal-close" data-close-modal aria-label="Sulge ülesande vorm">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
        <h2 class="task-modal-title" data-modal-title>Lisa ülesanne</h2>
        <form method="post" class="task-modal-form" id="task-modal-form">
          {% csrf_token %}
          <input type="hidden" name="action" value="create">
          <input type="hidden" name="task_id" value="">
          <label>
            <span>Ülesande nimi</span>
            <input type="text" name="name" placeholder="Hommikused tegemised" required>
          </label>
          <label>
            <span>Kirjeldus</span>
            <textarea name="description" rows="3" placeholder="Lisa täpsustused või meeldetuletused..."></textarea>
          </label>
          <label>
            <span>Määra kasutajale</span>
            <select name="assigned_to">
              <option value="">Avatud ülesanne (ükskõik milline laps)</option>
              {% for member in family_members %}
                <option value="{{ member.id }}">
                  {{ member.get_full_name|default:member.username }}
                  {% if member.role %}
                    ({{ member.get_role_display }})
                  {% endif %}
                </option>
              {% endfor %}
            </select>
          </label>
          <div class="task-modal-grid">
            <label>
              <span>Punktid</span>
              <input type="number" name="points" min="0" value="25">
            </label>
            <label>
              <span>Tähtsus</span>
              <select name="priority">
                <option value="0">Madal</option>
                <option value="1">Keskmine</option>
                <option value="2">Kõrge</option>
              </select>
            </label>
            <label>
              <span>Tähtaeg</span>
              <input type="date" name="due_date">
            </label>
          </div>
          <div class="form-actions">
            <button type="submit" class="primary-button">
              <span aria-hidden="true" data-submit-icon>+</span>
              <span data-submit-label>Salvesta ülesanne</span>
            </button>
          </div>
        </form>
      </div>
    </div>
  {% endif %}

  {% if is_parent %}
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const modal = document.getElementById('task-modal');
        if (!modal) return;

        const form = document.getElementById('task-modal-form');
        const actionInput = form.querySelector('input[name="action"]');
        const idInput = form.querySelector('input[name="task_id"]');
        const nameInput = form.querySelector('input[name="name"]');
        const descriptionInput = form.querySelector('textarea[name="description"]');
        const assignedSelect = form.querySelector('select[name="assigned_to"]');
        const pointsInput = form.querySelector('input[name="points"]');
        const prioritySelect = form.querySelector('select[name="priority"]');
        const dueInput = form.querySelector('input[name="due_date"]');
        const titleEl = modal.querySelector('[data-modal-title]');
        const submitLabel = modal.querySelector('[data-submit-label]');
        const submitIcon = modal.querySelector('[data-submit-icon]');

        submitIcon.dataset.createIcon = '+';
        submitIcon.dataset.editIcon = '✔';

        function openModal(mode, data = {}) {
          modal.classList.add('is-visible');
          document.body.classList.add('modal-open');
          form.reset();

          if (mode === 'create') {
            actionInput.value = 'create';
            idInput.value = '';
            titleEl.textContent = 'Lisa ülesanne';
            submitLabel.textContent = 'Salvesta ülesanne';
            submitIcon.textContent = submitIcon.dataset.createIcon || '+';
            assignedSelect.value = '';
          } else {
            actionInput.value = 'update';
            idInput.value = data.id || '';
            titleEl.textContent = 'Muuda ülesannet';
            submitLabel.textContent = 'Uuenda ülesannet';
            submitIcon.textContent = submitIcon.dataset.editIcon || '✔';

            nameInput.value = data.name || '';
            descriptionInput.value = data.description || '';
            pointsInput.value = data.points || 0;
            prioritySelect.value = data.priority ?? '0';
            dueInput.value = data.due || '';

            assignedSelect.value = '';
            if (data.assigned && assignedSelect.querySelector(`option[value="${data.assigned}"]`)) {
              assignedSelect.value = data.assigned;
            }
          }
        }

        function closeModal() {
          modal.classList.remove('is-visible');
          document.body.classList.remove('modal-open');
        }

        document.querySelectorAll('[data-open-task-modal="create"]').forEach((button) => {
          button.addEventListener('click', () => openModal('create'));
        });

        document.querySelectorAll('[data-open-task-modal="edit"]').forEach((button) => {
          button.addEventListener('click', () => {
            openModal('edit', {
              id: button.dataset.taskId,
              name: button.dataset.taskName,
              description: button.dataset.taskDescription,
              assigned: button.dataset.taskAssigned,
              points: button.dataset.taskPoints,
              priority: button.dataset.taskPriority,
              due: button.dataset.taskDue,
            });
          });
        });

        modal.querySelectorAll('[data-close-modal]').forEach((el) => {
          el.addEventListener('click', closeModal);
        });

        modal.addEventListener('click', (event) => {
          if (event.target === modal) {
            closeModal();
          }
        });

        document.addEventListener('keydown', (event) => {
          if (event.key === 'Escape' && modal.classList.contains('is-visible')) {
            closeModal();
          }
        });
      });

    </script>
  {% endif %}

  <script>
    // Custom confirmation modal - available for all users
    document.addEventListener('DOMContentLoaded', function () {
      const confirmModal = document.getElementById('confirm-modal');
      if (!confirmModal) return;
      
      const confirmTitle = document.getElementById('confirm-modal-title');
      const confirmMessage = document.getElementById('confirm-modal-message');
      const confirmButton = document.getElementById('confirm-modal-confirm');
      const cancelButton = document.getElementById('confirm-modal-cancel');
      const confirmOverlay = confirmModal.querySelector('.confirm-modal-overlay');
      
      if (!confirmTitle || !confirmMessage || !confirmButton || !cancelButton || !confirmOverlay) {
        console.error('Confirmation modal elements not found');
        return;
      }
      
      let confirmResolve = null;
      let pendingForm = null;
      let formSubmitHandler = null;

      function showConfirm(title, message) {
        return new Promise((resolve) => {
          confirmTitle.textContent = title;
          confirmMessage.textContent = message;
          confirmModal.classList.add('is-visible');
          document.body.classList.add('modal-open');
          confirmResolve = resolve;
        });
      }

      function closeConfirm(result) {
        confirmModal.classList.remove('is-visible');
        document.body.classList.remove('modal-open');
        if (confirmResolve) {
          confirmResolve(result);
          confirmResolve = null;
        }
        
        // If confirmed, submit the pending form
        if (result && pendingForm) {
          // Remove the data-confirm attribute so the form submits normally
          pendingForm.removeAttribute('data-confirm');
          
          // Remove the event listener temporarily
          if (formSubmitHandler) {
            pendingForm.removeEventListener('submit', formSubmitHandler);
          }
          
          // Submit the form directly (this bypasses event listeners)
          if (pendingForm.requestSubmit) {
            // Modern browsers - requestSubmit respects validation but allows submission
            pendingForm.requestSubmit();
          } else {
            // Fallback - create a submit event
            const submitEvent = new Event('submit', {
              bubbles: true,
              cancelable: true
            });
            const submitted = pendingForm.dispatchEvent(submitEvent);
            
            // If event wasn't prevented, submit directly
            if (submitted) {
              pendingForm.submit();
            }
          }
          
          // Re-add the data-confirm attribute and listener after a short delay
          setTimeout(() => {
            if (pendingForm && formSubmitHandler) {
              pendingForm.setAttribute('data-confirm', pendingForm.dataset.originalConfirm || '');
              pendingForm.addEventListener('submit', formSubmitHandler);
            }
          }, 100);
        }
        
        pendingForm = null;
        formSubmitHandler = null;
      }

      confirmButton.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        closeConfirm(true);
      });
      
      cancelButton.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        closeConfirm(false);
      });
      
      confirmOverlay.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        closeConfirm(false);
      });

      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && confirmModal.classList.contains('is-visible')) {
          closeConfirm(false);
        }
      });

      // Handle forms with data-confirm attribute
      document.querySelectorAll('form[data-confirm]').forEach((form) => {
        // Store original confirm message
        form.dataset.originalConfirm = form.getAttribute('data-confirm');
        
        const submitHandler = async function (e) {
          // Skip if form doesn't have data-confirm attribute (means it was removed for submission)
          if (!form.hasAttribute('data-confirm')) {
            return;
          }
          
          e.preventDefault();
          e.stopPropagation();
          const message = form.getAttribute('data-confirm');
          const action = form.querySelector('input[name="action"]')?.value || 'toiming';
          let title = 'Kinnita toiming';
          
          if (action === 'delete') {
            title = 'Kinnita kustutamine';
          } else if (action === 'reopen') {
            title = 'Kinnita avamine';
          } else if (action === 'complete') {
            title = 'Kinnita täitmine';
          } else if (action === 'approve') {
            title = 'Kinnita ülesanne';
          }
          
          pendingForm = form;
          formSubmitHandler = submitHandler;
          const confirmed = await showConfirm(title, message);
        };
        
        form.addEventListener('submit', submitHandler);
      });
    });
  </script>
{% endblock %}

