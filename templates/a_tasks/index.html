{% extends "base.html" %}

{% block title %}Ülesanded | Perekas{% endblock %}

{% block nav_tasks_active %} active{% endblock %}

{% block content %}
  {% if task_limit_info and not task_limit_info.can_create %}
    <div class="messages-container" id="task-limit-message-container">
      <div class="message-toast message-toast-error" id="task-limit-message" role="alert">
        <div class="message-toast-content">
          <span class="message-toast-text">
            <strong>Ülesandepiir saavutatud:</strong> Oled sel kuul loonud {{ task_limit_info.current }}/{{ task_limit_info.limit }} ülesannet. 
            <a href="{% url 'a_account:subscriptions' %}" style="color: currentColor; text-decoration: underline; font-weight: 600;">Uuenda tellimust</a>, et luua rohkem ülesandeid.
          </span>
        </div>
        <button type="button" class="message-toast-dismiss" aria-label="Sulge" onclick="dismissLimitMessage(this)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
    </div>
  {% endif %}
  <div class="page-container">
    <header class="page-header">
      <div>
        <h1 class="page-title">Ülesanded</h1>
        {% if has_family %}
          <p class="page-subtitle">
            Korralda koduseid tegemisi, jälgi punkte ja tähista väikeseid võite.
          </p>
        {% else %}
          <p class="page-subtitle">Loo või liitu perega, et hakata ülesandeid jagama.</p>
        {% endif %}
      </div>
    </header>

    {% if not has_family %}
      <section class="empty-state">
        <p>Perekonda pole veel ühendatud. Kui lood või liitud perega, saad hakata ülesandeid haldama.</p>
      </section>
    {% else %}
      {% if is_parent %}
        <form method="post" class="add-item-card" id="quick-add-task-form">
          {% csrf_token %}
          <input type="hidden" name="action" value="create">
          <label class="visually-hidden" for="quick-task-input">Lisa uus ülesanne</label>
          <div class="quick-add-input-wrapper">
            <div class="input-with-help">
              <input
                id="quick-task-input"
                name="task_text"
                type="text"
                placeholder="Kirjuta ülesanne... (nt. 'Võta prügi välja @Emma homme !kõrge')"
                {% if not has_family or task_limit_info and not task_limit_info.can_create %}disabled{% endif %}
                required
                autocomplete="off"
                data-task-limit-reached="{% if task_limit_info and not task_limit_info.can_create %}true{% else %}false{% endif %}"
              >
              <button type="button" class="task-help-button" id="task-help-button" aria-label="Näita abi">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"></circle>
                  <line x1="12" y1="16" x2="12" y2="12"></line>
                  <line x1="12" y1="8" x2="12.01" y2="8"></line>
                </svg>
              </button>
            </div>
            <div class="autocomplete-dropdown" id="autocomplete-dropdown" role="listbox" aria-label="Laste nimed"></div>
          </div>
          <button type="submit" class="primary-button" {% if not has_family or task_limit_info and not task_limit_info.can_create %}disabled{% endif %}>
            <span aria-hidden="true">+</span>
            <span>Lisa</span>
          </button>
        </form>
        
        <!-- Help Modal -->
        <div class="task-help-modal" id="task-help-modal" aria-hidden="true" role="dialog" aria-modal="true">
          <div class="task-help-modal-overlay" data-close-help-modal></div>
          <div class="task-help-modal-content">
            <button type="button" class="task-help-modal-close" data-close-help-modal aria-label="Sulge">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
            <h2 class="task-help-modal-title">Kuidas ülesandeid lisada?</h2>
            <div class="task-help-modal-body">
              <p class="task-help-intro">Kirjuta lihtsalt ülesande nimi või kasuta erimärke täpsemaks määramiseks:</p>
              <div class="task-help-grid">
                <div class="task-help-item">
                  <div class="task-help-item-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                      <circle cx="9" cy="7" r="4"></circle>
                      <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                      <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                  </div>
                  <div class="task-help-item-content">
                    <code>@nimi</code>
                    <span>Määra lapsele</span>
                  </div>
                </div>
                <div class="task-help-item">
                  <div class="task-help-item-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
                    </svg>
                  </div>
                  <div class="task-help-item-content">
                    <code>!kõrge</code>
                    <span>Tähtsus</span>
                  </div>
                </div>
                <div class="task-help-item">
                  <div class="task-help-item-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                    </svg>
                  </div>
                  <div class="task-help-item-content">
                    <code>+50</code>
                    <span>Punktid</span>
                  </div>
                </div>
                <div class="task-help-item">
                  <div class="task-help-item-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M1 4v6h6"></path>
                      <path d="M23 20v-6h-6"></path>
                      <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"></path>
                    </svg>
                  </div>
                  <div class="task-help-item-content">
                    <code>*nädalaselt</code>
                    <span>Korduv ülesanne (alustab tähtajast)</span>
                  </div>
                </div>
                <div class="task-help-item">
                  <div class="task-help-item-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                      <line x1="16" y1="2" x2="16" y2="6"></line>
                      <line x1="8" y1="2" x2="8" y2="6"></line>
                      <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                  </div>
                  <div class="task-help-item-content">
                    <code>homme</code>
                    <span>Tähtaeg</span>
                  </div>
                </div>
              </div>
              <div class="task-help-examples">
                <p class="task-help-examples-title">Näited:</p>
                <ul class="task-help-examples-list">
                  <li><code>"Võta prügi välja @Emma homme !kõrge"</code></li>
                  <li><code>"Pese hambad ära @kõigile"</code> - loob iga lapse jaoks sama ülesanne</li>
                  <li>
                    <code>"Pesu *nädalaselt"</code>
                    <svg class="task-status-icon recurring-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-label="Korduv" style="display: inline-block; vertical-align: middle; margin-left: 0.5rem; color: rgba(6, 182, 212, 0.9);">
                      <path d="M1 4v6h6"></path>
                      <path d="M23 20v-6h-6"></path>
                      <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"></path>
                    </svg>
                    <span style="margin-left: 0.5rem;">- kordub iga nädal sama päeval</span>
                  </li>
                  <li><code>"Kodutöö +50"</code></li>
                  <li><code>"Toida koera @Tom homme !madal +25"</code></li>
                  <li>
                    <code>"Koristus *igapäevaselt +30"</code>
                    <svg class="task-status-icon recurring-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-label="Korduv" style="display: inline-block; vertical-align: middle; margin-left: 0.5rem; color: rgba(6, 182, 212, 0.9);">
                      <path d="M1 4v6h6"></path>
                      <path d="M23 20v-6h-6"></path>
                      <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"></path>
                    </svg>
                    <span style="margin-left: 0.5rem;">- kordub iga päev</span>
                  </li>
                  <li>
                    <code>"Kontrolli postkasti *tööpäevaselt"</code>
                    <svg class="task-status-icon recurring-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-label="Korduv" style="display: inline-block; vertical-align: middle; margin-left: 0.5rem; color: rgba(6, 182, 212, 0.9);">
                      <path d="M1 4v6h6"></path>
                      <path d="M23 20v-6h-6"></path>
                      <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"></path>
                    </svg>
                    <span style="margin-left: 0.5rem;">- kordub iga tööpäev</span>
                  </li>
                  <li>
                    <code>"Vannitoa koristus *iga_teine_päev"</code>
                    <svg class="task-status-icon recurring-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-label="Korduv" style="display: inline-block; vertical-align: middle; margin-left: 0.5rem; color: rgba(6, 182, 212, 0.9);">
                      <path d="M1 4v6h6"></path>
                      <path d="M23 20v-6h-6"></path>
                      <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"></path>
                    </svg>
                    <span style="margin-left: 0.5rem;">- kordub iga teine päev</span>
                  </li>
                  <li><code>"Kodutöö @Emma reede *nädalaselt !kõrge +100"</code> - kordub iga reede</li>
                  <li>
                    <code>"Rent *kuus ^15.12.2024"</code>
                    <svg class="task-status-icon recurring-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-label="Korduv" style="display: inline-block; vertical-align: middle; margin-left: 0.5rem; color: rgba(6, 182, 212, 0.9);">
                      <path d="M1 4v6h6"></path>
                      <path d="M23 20v-6h-6"></path>
                      <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"></path>
                    </svg>
                    <span style="margin-left: 0.5rem;">- kordub iga kuu 15. kuupäeval</span>
                  </li>
                </ul>
              </div>
              <div class="task-help-options">
                <p class="task-help-examples-title">Võimalikud väärtused:</p>
                <div class="task-help-options-list">
                  <div class="task-help-option-group">
                    <strong>Määramine:</strong>
                    <div class="task-help-option-values">
                      <code>@nimi</code>
                      <code>@kõigile</code>
                    </div>
                    <p class="task-help-option-note">@nimi - määra lapsele, @kõigile - loo iga lapse jaoks sama ülesanne</p>
                  </div>
                  <div class="task-help-option-group">
                    <strong>Tähtsus:</strong>
                    <div class="task-help-option-values">
                      <code>!madal</code>
                      <code>!keskmine</code>
                      <code>!kõrge</code>
                    </div>
                  </div>
                  <div class="task-help-option-group">
                    <strong>Korduv:</strong>
                    <div class="task-help-option-values">
                      <code>*päevaselt</code>
                      <code>*tööpäevaselt</code>
                      <code>*iga_teine_päev</code>
                      <code>*nädalaselt</code>
                      <code>*kuus</code>
                    </div>
                    <p class="task-help-option-note">Korduv ülesanne algab tähtajast. Nädalaselt korduv ülesanne kordub samal nädalapäeval, kuus korduv samal kuupäeval.</p>
                  </div>
                  <div class="task-help-option-group">
                    <strong>Tähtaeg:</strong>
                    <div class="task-help-option-values">
                      <code>täna</code>
                      <code>homme</code>
                      <code>reede</code>
                      <code>esmaspäev</code>
                      <code>teisipäev</code>
                      <code>kolmapäev</code>
                      <code>neljapäev</code>
                      <code>laupäev</code>
                      <code>pühapäev</code>
                      <code>^25.12.2024</code>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      {% endif %}
      
      <section class="task-section">
        <div class="task-grid">
          {% if all_tasks %}
            {% for task in all_tasks %}
              <article class="task-card priority-{{ task.priority }}{% if task.is_in_progress %} in-progress{% endif %}{% if task.completed and task.approved %} approved{% elif task.completed and not task.approved %} awaiting{% endif %}">
                <div class="task-card-header">
                  <div>
                    <h3 class="task-name">
                      {% if task.completed and task.approved %}
                        <svg class="task-status-icon approved-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-label="Kinnitatud">
                          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                          <polyline points="22 4 12 14.01 9 11.01"></polyline>
                        </svg>
                      {% elif task.completed and not task.approved %}
                        <svg class="task-status-icon completed-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-label="Lõpetatud">
                          <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                      {% elif task.is_in_progress %}
                        <svg class="task-status-icon in-progress-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-label="Pooleli">
                          <circle cx="12" cy="12" r="10"></circle>
                          <polyline points="12 6 12 12 16 14"></polyline>
                        </svg>
                      {% endif %}
                      {{ task.name }}
                    </h3>
                    <p class="task-assigned">
                      {% if task.completed and task.approved %}
                        {% with winner=task.assigned_to|default:task.completed_by %}
                      {% if is_child %}
                            {% if winner == user %}
                              Punktid teenis: Sina
                            {% elif winner %}
                              Punktid teenis: {% if winner.first_name %}{{ winner.first_name }}{% else %}{{ winner.display_name }}{% endif %}
                            {% endif %}
                          {% elif winner %}
                            Punktid teenis: {% if winner.first_name %}{{ winner.first_name }}{% else %}{{ winner.display_name }}{% endif %}
                          {% endif %}
                        {% endwith %}
                      {% elif task.completed and not task.approved %}
                        {% if is_child %}
                          {% if task.assigned_to == user %}
                            Määratud: Sinule
                          {% elif task.assigned_to %}
                            Määratud: {% if task.assigned_to.first_name %}{{ task.assigned_to.first_name }}{% else %}{{ task.assigned_to.display_name }}{% endif %}
                          {% else %}
                            Määratud: Kõigile
                          {% endif %}
                        {% else %}
                          {% if task.assigned_to %}
                            Määratud: {% if task.assigned_to.first_name %}{{ task.assigned_to.first_name }}{% else %}{{ task.assigned_to.display_name }}{% endif %}
                          {% else %}
                            Määratud: Kõigile
                          {% endif %}
                        {% endif %}
                      {% elif is_child %}
                        {% if task.is_in_progress %}
                          {% if task.assigned_to == user %}
                            Teeb: Sina
                          {% elif task.assigned_to %}
                            Teeb: {% if task.assigned_to.first_name %}{{ task.assigned_to.first_name }}{% else %}{{ task.assigned_to.display_name }}{% endif %}
                          {% endif %}
                        {% elif task.assigned_to == user %}
                          Määratud: Sinule
                        {% elif task.assigned_to %}
                          Määratud: {% if task.assigned_to.first_name %}{{ task.assigned_to.first_name }}{% else %}{{ task.assigned_to.display_name }}{% endif %}
                        {% else %}
                          Määratud: Kõigile
                        {% endif %}
                      {% else %}
                        {% if task.is_in_progress and task.assigned_to %}
                          Teeb: {% if task.assigned_to.first_name %}{{ task.assigned_to.first_name }}{% else %}{{ task.assigned_to.display_name }}{% endif %}
                        {% elif task.assigned_to %}
                          Määratud: {% if task.assigned_to.first_name %}{{ task.assigned_to.first_name }}{% else %}{{ task.assigned_to.display_name }}{% endif %}
                        {% else %}
                          Määratud: Kõigile
                        {% endif %}
                      {% endif %}
                    </p>
                    {% if task.description %}
                      <p class="task-description">{{ task.description }}</p>
                    {% endif %}
                  </div>
                  <span class="task-points points-chip">
                    <span class="points-value">{{ task.points }}</span>
                    <span class="points-label">pkt</span>
                  </span>
                </div>
                <div class="task-meta">
                  <div class="task-meta-item">
                    <svg class="task-meta-icon" viewBox="0 0 24 24" aria-hidden="true">
                      <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
                    </svg>
                    <span class="task-meta-label">{% if task.priority == 0 %}Madal{% elif task.priority == 1 %}Keskmine{% else %}Kõrge{% endif %}</span>
                  </div>
                  {% if task.completed %}
                    <div class="task-meta-item">
                      <svg class="task-meta-icon" viewBox="0 0 24 24" aria-hidden="true">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12 6 12 12 16 14"></polyline>
                      </svg>
                      <span class="task-meta-label">Lõpetas {% if task.completed_by.first_name %}{{ task.completed_by.first_name }}{% else %}{{ task.completed_by.display_name }}{% endif %} {{ task.completed_at|date:"d.m.Y H:i" }}</span>
                    </div>
                  {% endif %}
                  {% if task.approved %}
                    <div class="task-meta-item">
                      <svg class="task-meta-icon" viewBox="0 0 24 24" aria-hidden="true">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12 6 12 12 16 14"></polyline>
                      </svg>
                      <span class="task-meta-label">Kinnitas {% if task.approved_by.first_name %}{{ task.approved_by.first_name }}{% else %}{{ task.approved_by.display_name }}{% endif %} {{ task.approved_at|date:"d.m.Y H:i" }}</span>
                    </div>
                  {% endif %}
                  {% if task.due_date %}
                    <div class="task-meta-item">
                      <svg class="task-meta-icon" viewBox="0 0 24 24" aria-hidden="true">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                      </svg>
                      <span class="task-meta-label">{{ task.due_date|date:"d.m" }}</span>
                    </div>
                  {% endif %}
                  {% if task.recurrences.exists %}
                    {% with recurrence=task.recurrences.first %}
                      <div class="task-meta-item">
                        <svg class="task-meta-icon" viewBox="0 0 24 24" aria-hidden="true" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <path d="M1 4v6h6"></path>
                          <path d="M23 20v-6h-6"></path>
                          <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"></path>
                        </svg>
                        <span class="task-meta-label">
                          {% if recurrence.frequency == 'daily' %}Iga päev
                          {% elif recurrence.frequency == 'business_daily' %}Iga tööpäev
                          {% elif recurrence.frequency == 'every_other_day' %}Iga teine päev
                          {% elif recurrence.frequency == 'weekly' %}Iga nädal
                          {% elif recurrence.frequency == 'monthly' %}Iga kuu
                          {% else %}Korduv{% endif %}
                        </span>
                      </div>
                    {% endwith %}
                  {% endif %}
                </div>
                <div class="task-actions">
                  {% if task.completed and not task.approved and is_parent %}
                    <form method="post" class="icon-form" data-confirm="Kas oled kindel, et soovid ülesande '{{ task.name }}' kinnitada? See annab {{ task.points }} punkti ja märgib ülesande kinnitatud.">
                      {% csrf_token %}
                      <input type="hidden" name="action" value="approve">
                      <input type="hidden" name="task_id" value="{{ task.id }}">
                      <button type="submit" class="icon-button success" aria-label="Kinnita {{ task.name }}">
                        <svg viewBox="0 0 24 24" aria-hidden="true">
                          <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                      </button>
                    </form>
                    <form method="post" class="icon-form" data-confirm="Kas soovid ülesande '{{ task.name }}' tagasi lükata? See eemaldab täitmise staatuse.">
                      {% csrf_token %}
                      <input type="hidden" name="action" value="reopen">
                      <input type="hidden" name="task_id" value="{{ task.id }}">
                      <button type="submit" class="icon-button" aria-label="Ava {{ task.name }} uuesti">
                        <svg viewBox="0 0 24 24" aria-hidden="true">
                          <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path>
                          <path d="M21 3v5h-5"></path>
                          <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path>
                          <path d="M3 21v-5h5"></path>
                        </svg>
                      </button>
                    </form>
                  {% endif %}
                  {% if task.can_child_start %}
                    <form method="post" class="icon-form" data-confirm="Kas soovid ülesande '{{ task.name }}' alustada?">
                      {% csrf_token %}
                      <input type="hidden" name="action" value="start">
                      <input type="hidden" name="task_id" value="{{ task.id }}">
                      <button type="submit" class="icon-button primary" aria-label="Alusta {{ task.name }}">
                        <svg viewBox="0 0 24 24" aria-hidden="true">
                          <polygon points="5 3 19 12 5 21 5 3"></polygon>
                        </svg>
                      </button>
                    </form>
                  {% endif %}
                  {% if task.can_child_complete %}
                    <form method="post" class="icon-form" data-confirm="Kas oled kindel, et soovid ülesande '{{ task.name }}' täita? See märgib ülesande lõpetatuks ja ootab kinnitust.">
                      {% csrf_token %}
                      <input type="hidden" name="action" value="complete">
                      <input type="hidden" name="task_id" value="{{ task.id }}">
                      <button type="submit" class="icon-button success" aria-label="Märgi {{ task.name }} tehtuks">
                        <svg viewBox="0 0 24 24" aria-hidden="true">
                          <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                      </button>
                    </form>
                  {% endif %}
                  {% if task.can_child_cancel %}
                    <form method="post" class="icon-form" data-confirm="Kas soovid ülesande '{{ task.name }}' tühistada?">
                      {% csrf_token %}
                      <input type="hidden" name="action" value="cancel">
                      <input type="hidden" name="task_id" value="{{ task.id }}">
                      <button type="submit" class="icon-button" aria-label="Tühista {{ task.name }}">
                        <svg viewBox="0 0 24 24" aria-hidden="true">
                          <line x1="18" y1="6" x2="6" y2="18"></line>
                          <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                      </button>
                    </form>
                  {% endif %}
                  {% if is_parent %}
                    {% if not task.completed %}
                    <button
                      type="button"
                      class="icon-button"
                      data-open-task-modal="edit"
                      data-task-id="{{ task.id }}"
                      data-task-name="{{ task.name|escape }}"
                      data-task-description="{{ task.description|default_if_none:''|escape }}"
                      data-task-assigned="{{ task.assigned_to_id|default:'' }}"
                      data-task-points="{{ task.points }}"
                      data-task-priority="{{ task.priority }}"
                      data-task-due="{{ task.due_date|date:'Y-m-d'|default_if_none:'' }}"
                      data-task-recurring-frequency="{% if task.recurrences.exists %}{{ task.recurrences.first.frequency }}{% endif %}"
                      data-task-recurring-day-of-week="{% if task.recurrences.exists %}{{ task.recurrences.first.day_of_week|default_if_none:'' }}{% endif %}"
                      data-task-recurring-day-of-month="{% if task.recurrences.exists %}{{ task.recurrences.first.day_of_month|default_if_none:'' }}{% endif %}"
                      data-task-recurring-end-date="{% if task.recurrences.exists %}{{ task.recurrences.first.end_date|date:'Y-m-d'|default_if_none:'' }}{% endif %}"
                    >
                      <svg viewBox="0 0 24 24" aria-hidden="true">
                        <path d="M12 20h9"></path>
                        <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4Z"></path>
                      </svg>
                    </button>
                    {% endif %}
                    <form method="post" class="icon-form" data-confirm="{% if task.recurrences.exists %}Kas oled kindel, et soovid ülesande '{{ task.name }}' kustutada? See kustutab ainult selle ülesande, mitte korduvat ülesannet. Korduva ülesande peatamiseks muuda ülesannet ja vali 'Ei kordu'.{% else %}Kas oled kindel, et soovid ülesande '{{ task.name }}' kustutada? Seda ei saa tagasi võtta.{% endif %}">
                      {% csrf_token %}
                      <input type="hidden" name="action" value="delete">
                      <input type="hidden" name="task_id" value="{{ task.id }}">
                      <button type="submit" class="icon-button" aria-label="Kustuta {{ task.name }}">
                        <svg viewBox="0 0 24 24" aria-hidden="true">
                          <polyline points="3 6 5 6 21 6"></polyline>
                          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                          <line x1="10" y1="11" x2="10" y2="17"></line>
                          <line x1="14" y1="11" x2="14" y2="17"></line>
                        </svg>
                      </button>
                    </form>
                  {% endif %}
                </div>
              </article>
            {% endfor %}
          {% else %}
            <p class="empty-state full-row">Aktiivseid ülesandeid pole. Võta hetk puhkuseks!</p>
          {% endif %}
        </div>
      </section>
    {% endif %}
  </div>

  <!-- Custom Confirmation Modal -->
  <div class="confirm-modal" id="confirm-modal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="confirm-modal-overlay"></div>
    <div class="confirm-modal-content">
      <h3 class="confirm-modal-title" id="confirm-modal-title">Kinnita toiming</h3>
      <p class="confirm-modal-message" id="confirm-modal-message"></p>
      <div class="confirm-modal-actions">
        <button type="button" class="confirm-modal-cancel" id="confirm-modal-cancel">Tühista</button>
        <button type="button" class="confirm-modal-confirm" id="confirm-modal-confirm">Kinnita</button>
      </div>
    </div>
  </div>

  {% if is_parent %}
    <div class="task-modal" id="task-modal" aria-hidden="true" role="dialog" aria-modal="true">
      <div class="task-modal-overlay" data-close-modal></div>
      <div class="task-modal-content">
        <button type="button" class="task-modal-close" data-close-modal aria-label="Sulge ülesande vorm">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
        <h2 class="task-modal-title" data-modal-title>Lisa ülesanne</h2>
        <form method="post" class="task-modal-form" id="task-modal-form">
          {% csrf_token %}
          <input type="hidden" name="action" value="create">
          <input type="hidden" name="task_id" value="">
          <label>
            <span>Ülesande nimi</span>
            <input type="text" name="name" placeholder="Hommikused tegemised" required>
          </label>
          <label>
            <span>Kirjeldus</span>
            <textarea name="description" rows="3" placeholder="Lisa täpsustused või meeldetuletused..."></textarea>
          </label>
          <label>
            <span>Määra kasutajale</span>
            <select name="assigned_to">
              <option value="">Avatud ülesanne (ükskõik milline laps)</option>
              {% for member in family_members %}
                <option value="{{ member.id }}">
                  {{ member.display_name }}
                  {% if member.role %}
                    ({{ member.get_role_display }})
                  {% endif %}
                </option>
              {% endfor %}
            </select>
          </label>
          <div class="task-modal-grid">
            <label>
              <span>Punktid</span>
              <input type="number" name="points" min="0" value="25">
            </label>
            <label>
              <span>Tähtsus</span>
              <select name="priority">
                <option value="0">Madal</option>
                <option value="1">Keskmine</option>
                <option value="2">Kõrge</option>
              </select>
            </label>
            <label>
              <span>Tähtaeg</span>
              <input type="date" name="due_date">
            </label>
          </div>
          <div class="task-modal-recurring">
            <label>
              <span>Korduv ülesanne</span>
              <select name="recurring_frequency" id="recurring-frequency">
                <option value="">Ei kordu</option>
                <option value="daily">Igapäevaselt</option>
                <option value="business_daily">Tööpäevaselt</option>
                <option value="every_other_day">Iga teine päev</option>
                <option value="weekly">Nädalaselt</option>
                <option value="monthly">Kuus</option>
              </select>
            </label>
            <p class="task-modal-recurring-note" id="recurring-note" style="display: none;">
              <small id="recurring-note-text"></small>
            </p>
            <label id="recurring-day-of-week-label" style="display: none;">
              <span>Nädalapäev</span>
              <select name="recurring_day_of_week" id="recurring-day-of-week">
                <option value="0">Esmaspäev</option>
                <option value="1">Teisipäev</option>
                <option value="2">Kolmapäev</option>
                <option value="3">Neljapäev</option>
                <option value="4">Reede</option>
                <option value="5">Laupäev</option>
                <option value="6">Pühapäev</option>
              </select>
            </label>
            <label id="recurring-day-of-month-label" style="display: none;">
              <span>Kuupäev (1-31)</span>
              <input type="number" name="recurring_day_of_month" id="recurring-day-of-month" min="1" max="31" placeholder="15">
            </label>
            <label id="recurring-end-date-label" style="display: none;">
              <span>Lõppkuupäev (valikuline)</span>
              <input type="date" name="recurring_end_date" id="recurring-end-date">
            </label>
          </div>
          <div class="form-actions">
            <button type="submit" class="primary-button">
              <span aria-hidden="true" data-submit-icon>+</span>
              <span data-submit-label>Salvesta ülesanne</span>
            </button>
          </div>
        </form>
      </div>
    </div>
  {% endif %}

  {% if is_parent %}
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const modal = document.getElementById('task-modal');
        if (!modal) return;

        const form = document.getElementById('task-modal-form');
        const actionInput = form.querySelector('input[name="action"]');
        const idInput = form.querySelector('input[name="task_id"]');
        const nameInput = form.querySelector('input[name="name"]');
        const descriptionInput = form.querySelector('textarea[name="description"]');
        const assignedSelect = form.querySelector('select[name="assigned_to"]');
        const pointsInput = form.querySelector('input[name="points"]');
        const prioritySelect = form.querySelector('select[name="priority"]');
        const dueInput = form.querySelector('input[name="due_date"]');
        const recurringFrequencySelect = form.querySelector('select[name="recurring_frequency"]');
        const recurringEndDateInput = form.querySelector('input[name="recurring_end_date"]');
        const recurringEndDateLabel = document.getElementById('recurring-end-date-label');
        const titleEl = modal.querySelector('[data-modal-title]');
        const submitLabel = modal.querySelector('[data-submit-label]');
        const submitIcon = modal.querySelector('[data-submit-icon]');

        submitIcon.dataset.createIcon = '+';
        submitIcon.dataset.editIcon = '✔';

        // Store whether task has existing recurrence (for limit checking)
        let taskHasExistingRecurrence = false;
        
        function openModal(mode, data = {}) {
          modal.classList.add('is-visible');
          document.body.classList.add('modal-open');
          form.reset();
          // Ensure modal is visible by scrolling viewport to top
          setTimeout(() => {
            window.scrollTo({ top: 0, behavior: 'smooth' });
            const modalContent = modal.querySelector('.task-modal-content');
            if (modalContent) {
              modalContent.scrollTop = 0;
            }
          }, 10);

          if (mode === 'create') {
            actionInput.value = 'create';
            idInput.value = '';
            titleEl.textContent = 'Lisa ülesanne';
            submitLabel.textContent = 'Salvesta ülesanne';
            submitIcon.textContent = submitIcon.dataset.createIcon || '+';
            assignedSelect.value = '';
            taskHasExistingRecurrence = false;
            updateRecurringLimitCheck();
          } else {
            actionInput.value = 'update';
            idInput.value = data.id || '';
            titleEl.textContent = 'Muuda ülesannet';
            submitLabel.textContent = 'Uuenda ülesannet';
            submitIcon.textContent = submitIcon.dataset.editIcon || '✔';

            nameInput.value = data.name || '';
            descriptionInput.value = data.description || '';
            pointsInput.value = data.points || 0;
            prioritySelect.value = data.priority ?? '0';
            dueInput.value = data.due || '';

            assignedSelect.value = '';
            if (data.assigned && assignedSelect.querySelector(`option[value="${data.assigned}"]`)) {
              assignedSelect.value = data.assigned;
            }
            
            // Set recurrence fields
            recurringFrequencySelect.value = data.recurringFrequency || '';
            recurringEndDateInput.value = data.recurringEndDate || '';
            recurringDayOfWeekSelect.value = data.recurringDayOfWeek || '';
            recurringDayOfMonthInput.value = data.recurringDayOfMonth || '';
            updateRecurringFieldsVisibility();
            
            // Check if task already has recurrence
            taskHasExistingRecurrence = data.recurringFrequency && data.recurringFrequency !== '';
            updateRecurringLimitCheck();
          }
        }
        
        // Update recurring limit check (called from openModal and when recurring frequency changes)
        function updateRecurringLimitCheck() {
          const recurringLimitInfo = {% if recurring_limit_info_json %}{{ recurring_limit_info_json|safe }}{% else %}null{% endif %};
          const currentValue = recurringFrequencySelect.value;
          
          // If limit reached and task doesn't have existing recurrence, disable non-empty options
          if (recurringLimitInfo && !recurringLimitInfo.can_create && !taskHasExistingRecurrence) {
            // Disable all frequency options except "Ei kordu" (empty value)
            Array.from(recurringFrequencySelect.options).forEach(option => {
              option.disabled = option.value !== '';
            });
            // If current value is a frequency (not empty), reset to empty
            if (currentValue !== '') {
              recurringFrequencySelect.value = '';
              updateRecurringFieldsVisibility();
            }
            showRecurringLimitMessage(recurringLimitInfo);
          } else {
            // Re-enable all options
            Array.from(recurringFrequencySelect.options).forEach(option => {
              option.disabled = false;
            });
            hideRecurringLimitMessage();
          }
        }
        
        // Show recurring limit message in modal
        function showRecurringLimitMessage(limitInfo) {
          let limitMsg = document.getElementById('recurring-limit-message');
          if (!limitMsg) {
            limitMsg = document.createElement('p');
            limitMsg.id = 'recurring-limit-message';
            limitMsg.className = 'recurring-limit-message';
            limitMsg.style.cssText = 'margin-top: 0.5rem; padding: 0.75rem; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 0.5rem; color: #fca5a5; font-size: 0.875rem; line-height: 1.5;';
            const recurringSection = document.querySelector('.task-modal-recurring');
            if (recurringSection) {
              recurringSection.appendChild(limitMsg);
            }
          }
          const tierName = limitInfo.tier === 'FREE' ? 'Tasuta' : limitInfo.tier === 'STARTER' ? 'Alustaja' : 'Pro';
          limitMsg.innerHTML = `<strong>Korduvate ülesannete piir saavutatud:</strong> Oled jõudnud oma limiidini (${limitInfo.current}/${limitInfo.limit} ${tierName} paketis). <a href="{% url 'a_account:subscriptions' %}" style="color: currentColor; text-decoration: underline; font-weight: 600;">Uuenda tellimust</a>, et luua rohkem korduvaid ülesandeid.`;
          limitMsg.style.display = 'block';
        }
        
        function hideRecurringLimitMessage() {
          const limitMsg = document.getElementById('recurring-limit-message');
          if (limitMsg) {
            limitMsg.style.display = 'none';
          }
        }
        
        // Also check limit when recurring frequency changes
        recurringFrequencySelect.addEventListener('change', function() {
          // If user tries to select a frequency when limit is reached and task doesn't have existing recurrence, prevent it
          if (!taskHasExistingRecurrence && this.value !== '') {
            const recurringLimitInfo = {% if recurring_limit_info_json %}{{ recurring_limit_info_json|safe }}{% else %}null{% endif %};
            if (recurringLimitInfo && !recurringLimitInfo.can_create) {
              // Reset to empty and show message
              this.value = '';
              updateRecurringFieldsVisibility();
              updateRecurringLimitCheck();
              return;
            }
          }
          updateRecurringFieldsVisibility();
        });
        
        const recurringNote = document.getElementById('recurring-note');
        const recurringNoteText = document.getElementById('recurring-note-text');
        const recurringDayOfWeekLabel = document.getElementById('recurring-day-of-week-label');
        const recurringDayOfWeekSelect = document.getElementById('recurring-day-of-week');
        const recurringDayOfMonthLabel = document.getElementById('recurring-day-of-month-label');
        const recurringDayOfMonthInput = document.getElementById('recurring-day-of-month');
        
        function updateRecurringFieldsVisibility() {
          const frequency = recurringFrequencySelect.value;
          
          if (!frequency) {
            // Hide all recurring fields
            recurringEndDateLabel.style.display = 'none';
            recurringNote.style.display = 'none';
            recurringDayOfWeekLabel.style.display = 'none';
            recurringDayOfMonthLabel.style.display = 'none';
            recurringEndDateInput.value = '';
            recurringDayOfWeekSelect.value = '';
            recurringDayOfMonthInput.value = '';
            return;
          }
          
          // Show end date and note
          recurringEndDateLabel.style.display = 'block';
          recurringNote.style.display = 'block';
          
          // Show/hide day selection based on frequency
          if (frequency === 'weekly') {
            recurringDayOfWeekLabel.style.display = 'block';
            recurringDayOfMonthLabel.style.display = 'none';
            recurringDayOfMonthInput.value = '';
            updateRecurringNote();
          } else if (frequency === 'monthly') {
            recurringDayOfWeekLabel.style.display = 'none';
            recurringDayOfWeekSelect.value = '';
            recurringDayOfMonthLabel.style.display = 'block';
            updateRecurringNote();
          } else if (frequency === 'daily') {
            recurringDayOfWeekLabel.style.display = 'none';
            recurringDayOfMonthLabel.style.display = 'none';
            recurringDayOfWeekSelect.value = '';
            recurringDayOfMonthInput.value = '';
            updateRecurringNote();
          } else if (frequency === 'business_daily') {
            recurringDayOfWeekLabel.style.display = 'none';
            recurringDayOfMonthLabel.style.display = 'none';
            recurringDayOfWeekSelect.value = '';
            recurringDayOfMonthInput.value = '';
            updateRecurringNote();
          } else if (frequency === 'every_other_day') {
            recurringDayOfWeekLabel.style.display = 'none';
            recurringDayOfMonthLabel.style.display = 'none';
            recurringDayOfWeekSelect.value = '';
            recurringDayOfMonthInput.value = '';
            updateRecurringNote();
          }
        }
        
        function updateRecurringNote() {
          const frequency = recurringFrequencySelect.value;
          
          if (!frequency) {
            recurringNoteText.textContent = '';
            return;
          }
          
          if (frequency === 'daily') {
            recurringNoteText.innerHTML = 'See ülesanne kordub <strong>iga päev</strong>.';
          } else if (frequency === 'business_daily') {
            recurringNoteText.innerHTML = 'See ülesanne kordub <strong>iga tööpäev</strong> (esmaspäevast reedeni).';
          } else if (frequency === 'every_other_day') {
            recurringNoteText.innerHTML = 'See ülesanne kordub <strong>iga teine päev</strong>.';
          } else if (frequency === 'weekly') {
            const dayOfWeek = parseInt(recurringDayOfWeekSelect.value);
            if (!isNaN(dayOfWeek)) {
              const weekdays = ['esmaspäev', 'teisipäev', 'kolmapäev', 'neljapäev', 'reede', 'laupäev', 'pühapäev'];
              const dayName = weekdays[dayOfWeek] || 'valitud päev';
              recurringNoteText.innerHTML = `See ülesanne kordub iga <strong>${dayName}</strong>.`;
            } else {
              recurringNoteText.innerHTML = 'Vali nädalapäev, mil ülesanne peaks korduma.';
            }
          } else if (frequency === 'monthly') {
            const dayOfMonth = parseInt(recurringDayOfMonthInput.value);
            if (!isNaN(dayOfMonth) && dayOfMonth >= 1 && dayOfMonth <= 31) {
              recurringNoteText.innerHTML = `See ülesanne kordub iga kuu <strong>${dayOfMonth}. kuupäeval</strong>.`;
            } else {
              recurringNoteText.innerHTML = 'Vali kuupäev (1-31), mil ülesanne peaks korduma.';
            }
          }
        }
        
        recurringFrequencySelect.addEventListener('change', updateRecurringFieldsVisibility);
        recurringDayOfWeekSelect.addEventListener('change', updateRecurringNote);
        recurringDayOfMonthInput.addEventListener('input', updateRecurringNote);

        function closeModal() {
          modal.classList.remove('is-visible');
          document.body.classList.remove('modal-open');
        }

        document.querySelectorAll('[data-open-task-modal="create"]').forEach((button) => {
          button.addEventListener('click', () => openModal('create'));
        });

        document.querySelectorAll('[data-open-task-modal="edit"]').forEach((button) => {
          button.addEventListener('click', () => {
            openModal('edit', {
              id: button.dataset.taskId,
              name: button.dataset.taskName,
              description: button.dataset.taskDescription,
              assigned: button.dataset.taskAssigned,
              points: button.dataset.taskPoints,
              priority: button.dataset.taskPriority,
              due: button.dataset.taskDue,
              recurringFrequency: button.dataset.taskRecurringFrequency || '',
              recurringDayOfWeek: button.dataset.taskRecurringDayOfWeek || '',
              recurringDayOfMonth: button.dataset.taskRecurringDayOfMonth || '',
              recurringEndDate: button.dataset.taskRecurringEndDate || '',
            });
          });
        });

        modal.querySelectorAll('[data-close-modal]').forEach((el) => {
          el.addEventListener('click', closeModal);
        });

        modal.addEventListener('click', (event) => {
          if (event.target === modal) {
            closeModal();
          }
        });

        document.addEventListener('keydown', (event) => {
          if (event.key === 'Escape' && modal.classList.contains('is-visible')) {
            closeModal();
          }
        });
      });

    </script>
  {% endif %}

  <script>
    // Custom confirmation modal - available for all users
    document.addEventListener('DOMContentLoaded', function () {
      const confirmModal = document.getElementById('confirm-modal');
      if (!confirmModal) return;
      
      const confirmTitle = document.getElementById('confirm-modal-title');
      const confirmMessage = document.getElementById('confirm-modal-message');
      const confirmButton = document.getElementById('confirm-modal-confirm');
      const cancelButton = document.getElementById('confirm-modal-cancel');
      const confirmOverlay = confirmModal.querySelector('.confirm-modal-overlay');
      
      if (!confirmTitle || !confirmMessage || !confirmButton || !cancelButton || !confirmOverlay) {
        console.error('Confirmation modal elements not found');
        return;
      }
      
      let confirmResolve = null;
      let pendingForm = null;
      let formSubmitHandler = null;

      function showConfirm(title, message) {
        return new Promise((resolve) => {
          confirmTitle.textContent = title;
          confirmMessage.textContent = message;
          // Prevent body scroll and ensure modal is visible
          document.body.classList.add('modal-open');
          confirmModal.classList.add('is-visible');
          // Scroll window to top to ensure modal is visible
          setTimeout(() => {
            window.scrollTo({ top: 0, behavior: 'smooth' });
            const modalContent = confirmModal.querySelector('.confirm-modal-content');
            if (modalContent) {
              modalContent.scrollTop = 0;
            }
          }, 10);
          confirmResolve = resolve;
        });
      }

      function closeConfirm(result) {
        confirmModal.classList.remove('is-visible');
        document.body.classList.remove('modal-open');
        if (confirmResolve) {
          confirmResolve(result);
          confirmResolve = null;
        }
        
        // If confirmed, submit the pending form
        if (result && pendingForm) {
          // Remove the data-confirm attribute so the form submits normally
          pendingForm.removeAttribute('data-confirm');
          
          // Remove the event listener temporarily
          if (formSubmitHandler) {
            pendingForm.removeEventListener('submit', formSubmitHandler);
          }
          
          // Submit the form directly (this bypasses event listeners)
          if (pendingForm.requestSubmit) {
            // Modern browsers - requestSubmit respects validation but allows submission
            pendingForm.requestSubmit();
          } else {
            // Fallback - create a submit event
            const submitEvent = new Event('submit', {
              bubbles: true,
              cancelable: true
            });
            const submitted = pendingForm.dispatchEvent(submitEvent);
            
            // If event wasn't prevented, submit directly
            if (submitted) {
              pendingForm.submit();
            }
          }
          
          // Re-add the data-confirm attribute and listener after a short delay
          setTimeout(() => {
            if (pendingForm && formSubmitHandler) {
              pendingForm.setAttribute('data-confirm', pendingForm.dataset.originalConfirm || '');
              pendingForm.addEventListener('submit', formSubmitHandler);
            }
          }, 100);
        }
        
        pendingForm = null;
        formSubmitHandler = null;
      }

      confirmButton.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        closeConfirm(true);
      });
      
      cancelButton.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        closeConfirm(false);
      });
      
      confirmOverlay.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        closeConfirm(false);
      });

      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && confirmModal.classList.contains('is-visible')) {
          closeConfirm(false);
        }
      });

      // Handle forms with data-confirm attribute
      document.querySelectorAll('form[data-confirm]').forEach((form) => {
        // Store original confirm message
        form.dataset.originalConfirm = form.getAttribute('data-confirm');
        
        const submitHandler = async function (e) {
          // Skip if form doesn't have data-confirm attribute (means it was removed for submission)
          if (!form.hasAttribute('data-confirm')) {
            return;
          }
          
          e.preventDefault();
          e.stopPropagation();
          const message = form.getAttribute('data-confirm');
          const action = form.querySelector('input[name="action"]')?.value || 'toiming';
          let title = 'Kinnita toiming';
          
          if (action === 'delete') {
            title = 'Kinnita kustutamine';
          } else if (action === 'reopen') {
            title = 'Kinnita tagasilükkamine';
          } else if (action === 'complete') {
            title = 'Kinnita täitmine';
          } else if (action === 'approve') {
            title = 'Kinnita ülesanne';
          }
          
          pendingForm = form;
          formSubmitHandler = submitHandler;
          const confirmed = await showConfirm(title, message);
        };
        
        form.addEventListener('submit', submitHandler);
      });
    });
  </script>

  {% if is_parent %}
    <script>
      // Help modal functionality
      document.addEventListener('DOMContentLoaded', function () {
        const helpButton = document.getElementById('task-help-button');
        const helpModal = document.getElementById('task-help-modal');
        const closeButtons = document.querySelectorAll('[data-close-help-modal]');
        
        if (!helpButton || !helpModal) return;
        
        function openHelpModal() {
          helpModal.setAttribute('aria-hidden', 'false');
          helpModal.classList.add('is-visible');
          document.body.classList.add('modal-open');
        }
        
        function closeHelpModal() {
          helpModal.setAttribute('aria-hidden', 'true');
          helpModal.classList.remove('is-visible');
          document.body.classList.remove('modal-open');
        }
        
        helpButton.addEventListener('click', openHelpModal);
        closeButtons.forEach(btn => btn.addEventListener('click', closeHelpModal));
        
        helpModal.addEventListener('click', (e) => {
          if (e.target === helpModal || e.target.classList.contains('task-help-modal-overlay')) {
            closeHelpModal();
          }
        });
        
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && helpModal.classList.contains('is-visible')) {
            closeHelpModal();
          }
        });
      });
    </script>
    
    <script>
      // Quick add form enhancements with autocomplete
      document.addEventListener('DOMContentLoaded', function () {
        const quickAddForm = document.getElementById('quick-add-task-form');
        const quickAddInput = document.getElementById('quick-task-input');
        const autocompleteDropdown = document.getElementById('autocomplete-dropdown');
        
        if (!quickAddForm || !quickAddInput) return;
        
        // Family members data for autocomplete
        const familyMembers = {{ family_members_data|default:"[]" }};
        
        // Limit information from backend
        const taskLimitInfo = {% if task_limit_info_json %}{{ task_limit_info_json|safe }}{% else %}null{% endif %};
        const recurringLimitInfo = {% if recurring_limit_info_json %}{{ recurring_limit_info_json|safe }}{% else %}null{% endif %};
        
        // Autocomplete options for different symbols
        const autocompleteOptions = {
          '@': {
            items: [
              // Special option for creating tasks for all children
              { 
                type: 'everyone', 
                display_text: 'Iga lapse jaoks', 
                username: 'kõigile',
                first_name: 'kõigile',
                search_text: 'kõigile everyone kõik all iga lapse jaoks'
              },
              ...familyMembers
            ],
            getDisplayText: (item) => {
              if (item.type === 'everyone') {
                return item.display_text;
              }
              return item.display_text;
            },
            getInsertText: (item) => {
              if (item.type === 'everyone') {
                return '@kõigile';
              }
              return `@${item.username || item.first_name || 'kõik'}`;
            },
            filter: (query, items) => {
              if (!query || query.length < 1) {
                // Show "everyone" option first, then first 7 family members
                const everyoneItem = items.find(item => item.type === 'everyone');
                const otherItems = items.filter(item => item.type !== 'everyone').slice(0, 7);
                return everyoneItem ? [everyoneItem, ...otherItems] : otherItems;
              }
              const lowerQuery = query.toLowerCase();
              const filtered = items.filter(item => {
                if (item.type === 'everyone') {
                  // Match "kõigile", "everyone", "kõik", "all"
                  return item.search_text.includes(lowerQuery) || 
                         'kõigile'.includes(lowerQuery) ||
                         'everyone'.includes(lowerQuery) ||
                         'kõik'.includes(lowerQuery) ||
                         'all'.includes(lowerQuery);
                }
                const searchText = (item.search_text || '').toLowerCase();
                const displayText = (item.display_text || '').toLowerCase();
                const username = (item.username || '').toLowerCase();
                const firstName = (item.first_name || '').toLowerCase();
                return searchText.includes(lowerQuery) || 
                       displayText.includes(lowerQuery) ||
                       username.includes(lowerQuery) || 
                       firstName.includes(lowerQuery);
              });
              // Always show "everyone" first if it matches, then other results
              const everyoneItem = filtered.find(item => item.type === 'everyone');
              const otherItems = filtered.filter(item => item.type !== 'everyone');
              return everyoneItem ? [everyoneItem, ...otherItems] : otherItems;
            }
          },
          '!': {
            items: [
              { value: 'madal', label: 'Madal', english: 'low' },
              { value: 'keskmine', label: 'Keskmine', english: 'medium' },
              { value: 'kõrge', label: 'Kõrge', english: 'high' }
            ],
            getDisplayText: (item) => item.label,
            getInsertText: (item) => `!${item.value}`,
            filter: (query, items) => {
              const lowerQuery = query.toLowerCase();
              return items.filter(item => 
                item.value.includes(lowerQuery) || 
                item.label.toLowerCase().includes(lowerQuery) ||
                item.english.includes(lowerQuery)
              );
            }
          },
          '*': {
            items: [
              { value: 'päevaselt', label: 'Igapäevaselt', english: 'daily' },
              { value: 'tööpäevaselt', label: 'Tööpäevaselt', english: 'business_daily' },
              { value: 'iga_teine_päev', label: 'Iga teine päev', english: 'every_other_day' },
              { value: 'nädalaselt', label: 'Nädalaselt', english: 'weekly' },
              { value: 'kuus', label: 'Kuus', english: 'monthly' }
            ],
            getDisplayText: (item) => item.label,
            getInsertText: (item) => `*${item.value}`,
            filter: (query, items) => {
              const lowerQuery = query.toLowerCase();
              return items.filter(item => 
                item.value.includes(lowerQuery) || 
                item.label.toLowerCase().includes(lowerQuery) ||
                item.english.includes(lowerQuery)
              );
            }
          },
          'date': {
            items: [
              { value: 'täna', label: 'Täna', english: 'today' },
              { value: 'homme', label: 'Homme', english: 'tomorrow' },
              { value: 'esmaspäev', label: 'Esmaspäev', english: 'monday' },
              { value: 'teisipäev', label: 'Teisipäev', english: 'tuesday' },
              { value: 'kolmapäev', label: 'Kolmapäev', english: 'wednesday' },
              { value: 'neljapäev', label: 'Neljapäev', english: 'thursday' },
              { value: 'reede', label: 'Reede', english: 'friday' },
              { value: 'laupäev', label: 'Laupäev', english: 'saturday' },
              { value: 'pühapäev', label: 'Pühapäev', english: 'sunday' },
              { value: 'järgmine nädal', label: 'Järgmine nädal', english: 'next week' }
            ],
            getDisplayText: (item) => item.label,
            getInsertText: (item) => item.value,
            filter: (query, items) => {
              const lowerQuery = query.toLowerCase();
              return items.filter(item => 
                item.value.includes(lowerQuery) || 
                item.label.toLowerCase().includes(lowerQuery) ||
                item.english.includes(lowerQuery)
              );
            }
          }
        };
        
        let selectedIndex = -1;
        let filteredItems = [];
        let currentAutocompleteType = null;
        
        // Auto-focus on desktop (not mobile to prevent keyboard popup)
        if (window.innerWidth > 768) {
          quickAddInput.focus();
        }
        
        // Autocomplete functionality
        function showAutocomplete(matches, autocompleteType) {
          // Check if recurring limit is reached when showing recurring options
          if (autocompleteType === '*' && recurringLimitInfo && !recurringLimitInfo.can_create) {
            const tierName = recurringLimitInfo.tier === 'FREE' ? 'Tasuta' : recurringLimitInfo.tier === 'STARTER' ? 'Alustaja' : 'Pro';
            const subscriptionsUrl = "{% url 'a_account:subscriptions' %}";
            autocompleteDropdown.innerHTML = `
              <div class="autocomplete-item autocomplete-limit-message" role="option" style="padding: 1rem; color: #fca5a5; border-bottom: 1px solid rgba(239, 68, 68, 0.2);">
                <div style="font-weight: 600; margin-bottom: 0.25rem;">Aktiivsete korduvate ülesannete piir saavutatud</div>
                <div style="font-size: 0.875rem; opacity: 0.9;">
                  Oled jõudnud oma limiidini (${recurringLimitInfo.current}/${recurringLimitInfo.limit} ${tierName} paketis).
                  <a href="${subscriptionsUrl}" style="color: #fca5a5; text-decoration: underline; display: inline-block; margin-top: 0.5rem;">Uuenda tellimust</a>, et luua rohkem aktiivseid korduvaid ülesandeid.
                </div>
              </div>
            `;
            autocompleteDropdown.classList.add('is-visible');
            return;
          }
          
          if (!matches || matches.length === 0) {
            autocompleteDropdown.innerHTML = '';
            autocompleteDropdown.classList.remove('is-visible');
            return;
          }
          
          filteredItems = matches;
          currentAutocompleteType = autocompleteType;
          selectedIndex = -1;
          
          const config = autocompleteOptions[autocompleteType];
          
          autocompleteDropdown.innerHTML = matches.map((item, index) => {
            return `<div class="autocomplete-item" data-index="${index}" role="option" tabindex="0">
              <span class="autocomplete-name">${config.getDisplayText(item)}</span>
            </div>`;
          }).join('');
          
          autocompleteDropdown.classList.add('is-visible');
          
          // Add click handlers
          autocompleteDropdown.querySelectorAll('.autocomplete-item').forEach((item, index) => {
            item.addEventListener('click', () => {
              // Don't allow selection if recurring limit is reached
              if (autocompleteType === '*' && recurringLimitInfo && !recurringLimitInfo.can_create) {
                return;
              }
              selectItem(matches[index], autocompleteType);
            });
            item.addEventListener('mousedown', (e) => e.preventDefault()); // Prevent input blur
          });
        }
        
        function hideAutocomplete() {
          autocompleteDropdown.classList.remove('is-visible');
          selectedIndex = -1;
          filteredItems = [];
          currentAutocompleteType = null;
        }
        
        function selectItem(item, autocompleteType) {
          const inputValue = quickAddInput.value;
          const cursorPos = quickAddInput.selectionStart;
          const config = autocompleteOptions[autocompleteType];
          const insertText = config.getInsertText(item);
          
          // Find the symbol position
          let symbolStart = -1;
          let symbol = '';
          
          if (autocompleteType === '@') {
            symbolStart = inputValue.lastIndexOf('@', cursorPos - 1);
            symbol = '@';
          } else if (autocompleteType === '!') {
            symbolStart = inputValue.lastIndexOf('!', cursorPos - 1);
            symbol = '!';
          } else if (autocompleteType === '+') {
            symbolStart = inputValue.lastIndexOf('+', cursorPos - 1);
            symbol = '+';
          } else if (autocompleteType === '*') {
            symbolStart = inputValue.lastIndexOf('*', cursorPos - 1);
            symbol = '*';
          } else if (autocompleteType === 'date') {
            // For dates, find the word being typed
            const textBeforeCursor = inputValue.substring(0, cursorPos);
            const wordMatch = textBeforeCursor.match(/(\S+)$/);
            if (wordMatch) {
              symbolStart = cursorPos - wordMatch[1].length;
            }
          }
          
          if (symbolStart === -1 && autocompleteType !== 'date') {
            // No symbol found, insert at cursor
            const before = inputValue.substring(0, cursorPos);
            const after = inputValue.substring(cursorPos);
            quickAddInput.value = before + insertText + ' ' + after;
            quickAddInput.focus();
            const newPos = cursorPos + insertText.length + 1;
            quickAddInput.setSelectionRange(newPos, newPos);
          } else if (symbolStart >= 0) {
            // Replace the symbol and query
            const before = inputValue.substring(0, symbolStart + 1);
            let after = inputValue.substring(cursorPos);
            // Remove the query part
            if (autocompleteType === 'date') {
              const textBeforeCursor = inputValue.substring(0, cursorPos);
              const wordMatch = textBeforeCursor.match(/(\S+)$/);
              if (wordMatch) {
                after = inputValue.substring(cursorPos);
                const beforeWord = inputValue.substring(0, symbolStart);
                quickAddInput.value = beforeWord + insertText + ' ' + after;
                quickAddInput.focus();
                const newPos = symbolStart + insertText.length + 1;
                quickAddInput.setSelectionRange(newPos, newPos);
              } else {
                quickAddInput.value = before + insertText + ' ' + after;
                quickAddInput.focus();
                const newPos = symbolStart + 1 + insertText.length + 1;
                quickAddInput.setSelectionRange(newPos, newPos);
              }
            } else {
              const afterMatch = inputValue.substring(symbolStart + 1, cursorPos).match(/^(\S*)/);
              const queryLength = afterMatch ? afterMatch[1].length : 0;
              after = inputValue.substring(symbolStart + 1 + queryLength);
              quickAddInput.value = before + insertText.replace(symbol, '') + ' ' + after;
              quickAddInput.focus();
              const newPos = symbolStart + 1 + insertText.replace(symbol, '').length + 1;
              quickAddInput.setSelectionRange(newPos, newPos);
            }
          } else {
            // Date without symbol - insert at cursor
            const before = inputValue.substring(0, cursorPos);
            const after = inputValue.substring(cursorPos);
            quickAddInput.value = before + insertText + ' ' + after;
            quickAddInput.focus();
            const newPos = cursorPos + insertText.length + 1;
            quickAddInput.setSelectionRange(newPos, newPos);
          }
          
          hideAutocomplete();
        }
        
        function detectAutocompleteType(textBeforeCursor, cursorPos) {
          // Check for @ mentions
          const mentionMatch = textBeforeCursor.match(/@(\w*)$/);
          if (mentionMatch) {
            return { type: '@', query: mentionMatch[1], start: textBeforeCursor.lastIndexOf('@') };
          }
          
          // Check for ! priority
          const priorityMatch = textBeforeCursor.match(/!(\w*)$/);
          if (priorityMatch) {
            return { type: '!', query: priorityMatch[1], start: textBeforeCursor.lastIndexOf('!') };
          }
          
          // Check for * recurring
          const recurringMatch = textBeforeCursor.match(/\*(\w*)$/);
          if (recurringMatch) {
            return { type: '*', query: recurringMatch[1], start: textBeforeCursor.lastIndexOf('*') };
          }
          
          // Check for date keywords (word at cursor)
          const wordMatch = textBeforeCursor.match(/(\S+)$/);
          if (wordMatch) {
            const word = wordMatch[1].toLowerCase();
            // Check if it looks like a date keyword
            const dateKeywords = ['täna', 'homme', 'esmaspäev', 'teisipäev', 'kolmapäev', 'neljapäev', 'reede', 'laupäev', 'pühapäev', 'järgmine'];
            if (dateKeywords.some(keyword => keyword.startsWith(word) || word.startsWith(keyword))) {
              return { type: 'date', query: word, start: textBeforeCursor.length - word.length };
            }
          }
          
          return null;
        }
        
        // Handle input for autocomplete
        quickAddInput.addEventListener('input', function (e) {
          const value = this.value;
          const cursorPos = this.selectionStart;
          const textBeforeCursor = value.substring(0, cursorPos);
          
          const autocompleteInfo = detectAutocompleteType(textBeforeCursor, cursorPos);
          
          if (autocompleteInfo) {
            const config = autocompleteOptions[autocompleteInfo.type];
            const matches = config.filter(autocompleteInfo.query, config.items).slice(0, 8); // Limit to 8 results
            showAutocomplete(matches, autocompleteInfo.type);
          } else {
            hideAutocomplete();
          }
        });
        
        // Handle keyboard navigation
        quickAddInput.addEventListener('keydown', function (e) {
          if (autocompleteDropdown.classList.contains('is-visible') && filteredItems.length > 0) {
            if (e.key === 'ArrowDown') {
              e.preventDefault();
              selectedIndex = Math.min(selectedIndex + 1, filteredItems.length - 1);
              updateSelectedItem();
            } else if (e.key === 'ArrowUp') {
              e.preventDefault();
              selectedIndex = Math.max(selectedIndex - 1, -1);
              updateSelectedItem();
            } else if (e.key === 'Enter' && selectedIndex >= 0) {
              e.preventDefault();
              selectItem(filteredItems[selectedIndex], currentAutocompleteType);
            } else if (e.key === 'Escape') {
              hideAutocomplete();
            }
          } else if (e.key === 'Enter' && !e.shiftKey && !e.ctrlKey && !e.metaKey) {
            e.preventDefault();
            quickAddForm.submit();
          } else if (e.key === 'Escape') {
            this.value = '';
            this.blur();
            hideAutocomplete();
          }
        });
        
        function updateSelectedItem() {
          const items = autocompleteDropdown.querySelectorAll('.autocomplete-item');
          items.forEach((item, index) => {
            item.classList.toggle('is-selected', index === selectedIndex);
          });
          // Scroll selected item into view
          if (selectedIndex >= 0 && items[selectedIndex]) {
            items[selectedIndex].scrollIntoView({ block: 'nearest', behavior: 'smooth' });
          }
        }
        
        // Hide autocomplete when clicking outside
        document.addEventListener('click', function (e) {
          if (!quickAddInput.contains(e.target) && !autocompleteDropdown.contains(e.target)) {
            hideAutocomplete();
          }
        });
        
        // Prevent zoom on iOS when focusing input
        if (/iPhone|iPad|iPod/.test(navigator.userAgent)) {
          quickAddInput.addEventListener('focus', function () {
            const viewport = document.querySelector('meta[name="viewport"]');
            if (viewport) {
              viewport.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no');
            }
          });
          
          quickAddInput.addEventListener('blur', function () {
            const viewport = document.querySelector('meta[name="viewport"]');
            if (viewport) {
              viewport.setAttribute('content', 'width=device-width, initial-scale=1.0');
            }
          });
        }
        
        // Clear input after successful submission (form will redirect, but just in case)
        quickAddForm.addEventListener('submit', function () {
          hideAutocomplete();
          // Input will be cleared on redirect, but we can clear it here too
          setTimeout(function () {
            quickAddInput.value = '';
          }, 100);
        });
      });
      
      // Dismiss limit message (does not auto-dismiss)
      function dismissLimitMessage(button) {
        const message = button.closest('.message-toast');
        const container = button.closest('.messages-container');
        message.style.opacity = '0';
        message.style.transform = 'translateY(-10px)';
        setTimeout(() => {
          message.remove();
          // If container is empty, remove it
          if (container && container.children.length === 0) {
            container.remove();
          }
        }, 200);
      }
    </script>
  {% endif %}
{% endblock %}

