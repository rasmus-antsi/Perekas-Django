{% extends "base.html" %}

{% block title %}Ülesanded | Perekas{% endblock %}

{% block nav_tasks_active %} active{% endblock %}

{% block content %}
  <div class="page-container">
    <header class="page-header">
      <div>
        <h1 class="page-title">Ülesanded</h1>
        {% if has_family %}
          <p class="page-subtitle">
            Korralda koduseid tegemisi, jälgi punkte ja tähista väikeseid võite.
          </p>
        {% else %}
          <p class="page-subtitle">Loo või liitu perega, et hakata ülesandeid jagama.</p>
        {% endif %}
      </div>
    </header>

    {% if not has_family %}
      <section class="empty-state">
        <p>Perekonda pole veel ühendatud. Kui lood või liitud perega, saad hakata ülesandeid haldama.</p>
      </section>
    {% else %}
      {% if is_parent %}
        <form method="post" class="add-item-card" id="quick-add-task-form">
          {% csrf_token %}
          <input type="hidden" name="action" value="create">
          <label class="visually-hidden" for="quick-task-input">Lisa uus ülesanne</label>
          <div class="quick-add-input-wrapper">
            <div class="input-with-help">
              <input
                id="quick-task-input"
                name="task_text"
                type="text"
                placeholder="Kirjuta ülesanne... (nt. 'Võta prügi välja @Emma homme !kõrge')"
                {% if not has_family %}disabled{% endif %}
                required
                autocomplete="off"
              >
              <button type="button" class="task-help-button" id="task-help-button" aria-label="Näita abi">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"></circle>
                  <line x1="12" y1="16" x2="12" y2="12"></line>
                  <line x1="12" y1="8" x2="12.01" y2="8"></line>
                </svg>
              </button>
            </div>
            <div class="autocomplete-dropdown" id="autocomplete-dropdown" role="listbox" aria-label="Laste nimed"></div>
          </div>
          <button type="submit" class="primary-button" {% if not has_family %}disabled{% endif %}>
            <span aria-hidden="true">+</span>
            <span>Lisa</span>
          </button>
        </form>
        
        <!-- Help Modal -->
        <div class="task-help-modal" id="task-help-modal" aria-hidden="true" role="dialog" aria-modal="true">
          <div class="task-help-modal-overlay" data-close-help-modal></div>
          <div class="task-help-modal-content">
            <button type="button" class="task-help-modal-close" data-close-help-modal aria-label="Sulge">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
            <h2 class="task-help-modal-title">Kuidas ülesandeid lisada?</h2>
            <div class="task-help-modal-body">
              <p class="task-help-intro">Kirjuta lihtsalt ülesande nimi või kasuta erimärke täpsemaks määramiseks:</p>
              <div class="task-help-grid">
                <div class="task-help-item">
                  <div class="task-help-item-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                      <circle cx="9" cy="7" r="4"></circle>
                      <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                      <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                  </div>
                  <div class="task-help-item-content">
                    <code>@nimi</code>
                    <span>Määra lapsele</span>
                  </div>
                </div>
                <div class="task-help-item">
                  <div class="task-help-item-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
                    </svg>
                  </div>
                  <div class="task-help-item-content">
                    <code>!kõrge</code>
                    <span>Tähtsus</span>
                  </div>
                </div>
                <div class="task-help-item">
                  <div class="task-help-item-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                    </svg>
                  </div>
                  <div class="task-help-item-content">
                    <code>+50</code>
                    <span>Punktid</span>
                  </div>
                </div>
                <div class="task-help-item">
                  <div class="task-help-item-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                    </svg>
                  </div>
                  <div class="task-help-item-content">
                    <code>*nädalaselt</code>
                    <span>Korduv ülesanne</span>
                  </div>
                </div>
                <div class="task-help-item">
                  <div class="task-help-item-icon">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                      <line x1="16" y1="2" x2="16" y2="6"></line>
                      <line x1="8" y1="2" x2="8" y2="6"></line>
                      <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                  </div>
                  <div class="task-help-item-content">
                    <code>homme</code>
                    <span>Tähtaeg</span>
                  </div>
                </div>
              </div>
              <div class="task-help-examples">
                <p class="task-help-examples-title">Näited:</p>
                <ul class="task-help-examples-list">
                  <li><code>"Võta prügi välja @Emma homme !kõrge"</code></li>
                  <li><code>"Pesu *nädalaselt"</code></li>
                  <li><code>"Kodutöö +50"</code></li>
                  <li><code>"Toida koer @Tom homme !madal +25"</code></li>
                  <li><code>"Koristus *igapäevaselt +30"</code></li>
                  <li><code>"Kodutöö @Emma reedel !kõrge +100"</code></li>
                </ul>
              </div>
              <div class="task-help-options">
                <p class="task-help-examples-title">Võimalikud väärtused:</p>
                <div class="task-help-options-list">
                  <div class="task-help-option-group">
                    <strong>Tähtsus:</strong>
                    <div class="task-help-option-values">
                      <code>!madal</code>
                      <code>!keskmine</code>
                      <code>!kõrge</code>
                    </div>
                  </div>
                  <div class="task-help-option-group">
                    <strong>Korduv:</strong>
                    <div class="task-help-option-values">
                      <code>*päevaselt</code>
                      <code>*nädalaselt</code>
                      <code>*kuus</code>
                    </div>
                  </div>
                  <div class="task-help-option-group">
                    <strong>Tähtaeg:</strong>
                    <div class="task-help-option-values">
                      <code>täna</code>
                      <code>homme</code>
                      <code>reede</code>
                      <code>esmaspäev</code>
                      <code>teisipäev</code>
                      <code>kolmapäev</code>
                      <code>neljapäev</code>
                      <code>laupäev</code>
                      <code>pühapäev</code>
                      <code>^2024-12-25</code>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      {% endif %}
      
      <section class="task-section">
        <header class="list-section-header">
          <span class="list-section-icon need-icon" aria-hidden="true"></span>
          <h2>Aktiivsed ülesanded</h2>
        </header>
        <div class="task-grid">
          {% if active_tasks %}
            {% for task in active_tasks %}
              <article class="task-card priority-{{ task.priority }}{% if task.is_in_progress %} in-progress{% endif %}">
                <div class="task-card-header">
                  <div>
                    <h3 class="task-name">
                      {% if task.is_in_progress %}
                        <svg class="task-status-icon in-progress-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-label="Pooleli">
                          <circle cx="12" cy="12" r="10"></circle>
                          <polyline points="12 6 12 12 16 14"></polyline>
                        </svg>
                      {% endif %}
                      {{ task.name }}
                    </h3>
                    <p class="task-assigned">
                      {% if is_child %}
                        {% if task.is_in_progress %}
                          {% if task.assigned_to == user %}
                            Teeb: Sina
                          {% else %}
                            Teeb: {% if task.assigned_to.first_name %}{{ task.assigned_to.first_name }}{% if task.assigned_to.username %} @{{ task.assigned_to.username }}{% endif %}{% else %}{{ task.assigned_to.display_name }}{% endif %}
                          {% endif %}
                        {% elif task.assigned_to == user %}
                          Määratud: Sinule
                        {% elif task.assigned_to %}
                          Määratud: {% if task.assigned_to.first_name %}{{ task.assigned_to.first_name }}{% if task.assigned_to.username %} @{{ task.assigned_to.username }}{% endif %}{% else %}{{ task.assigned_to.display_name }}{% endif %}
                        {% else %}
                          Määratud: Kõigile
                        {% endif %}
                      {% else %}
                        {% if task.is_in_progress %}
                          Teeb: {% if task.assigned_to.first_name %}{{ task.assigned_to.first_name }}{% if task.assigned_to.username %} @{{ task.assigned_to.username }}{% endif %}{% else %}{{ task.assigned_to.display_name }}{% endif %}
                        {% elif task.assigned_to %}
                          Määratud: {% if task.assigned_to.first_name %}{{ task.assigned_to.first_name }}{% if task.assigned_to.username %} @{{ task.assigned_to.username }}{% endif %}{% else %}{{ task.assigned_to.display_name }}{% endif %}
                        {% else %}
                          Määratud: Kõigile
                        {% endif %}
                      {% endif %}
                    </p>
                    {% if task.description %}
                      <p class="task-description">{{ task.description }}</p>
                    {% endif %}
                  </div>
                  <span class="task-points points-chip">
                    <span class="points-value">{{ task.points }}</span>
                    <span class="points-label">pkt</span>
                  </span>
                </div>
                <div class="task-meta">
                  <div class="task-meta-item">
                    <svg class="task-meta-icon" viewBox="0 0 24 24" aria-hidden="true">
                      <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
                    </svg>
                    <span class="task-meta-label">{% if task.priority == 0 %}Madal{% elif task.priority == 1 %}Keskmine{% else %}Kõrge{% endif %}</span>
                  </div>
                  {% if task.due_date %}
                    <div class="task-meta-item">
                      <svg class="task-meta-icon" viewBox="0 0 24 24" aria-hidden="true">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                      </svg>
                      <span class="task-meta-label">{{ task.due_date|date:"j.m" }}</span>
                    </div>
                  {% endif %}
                </div>
                <div class="task-actions">
                  {% if task.can_child_start %}
                    <form method="post" class="icon-form" data-confirm="Kas soovid ülesande '{{ task.name }}' alustada?">
                      {% csrf_token %}
                      <input type="hidden" name="action" value="start">
                      <input type="hidden" name="task_id" value="{{ task.id }}">
                      <button type="submit" class="icon-button primary" aria-label="Alusta {{ task.name }}">
                        <svg viewBox="0 0 24 24" aria-hidden="true">
                          <polygon points="5 3 19 12 5 21 5 3"></polygon>
                        </svg>
                      </button>
                    </form>
                  {% endif %}
                  {% if task.can_child_complete %}
                    <form method="post" class="icon-form" data-confirm="Kas oled kindel, et soovid ülesande '{{ task.name }}' täita? See märgib ülesande lõpetatuks ja ootab kinnitust.">
                      {% csrf_token %}
                      <input type="hidden" name="action" value="complete">
                      <input type="hidden" name="task_id" value="{{ task.id }}">
                      <button type="submit" class="icon-button success" aria-label="Märgi {{ task.name }} tehtuks">
                        <svg viewBox="0 0 24 24" aria-hidden="true">
                          <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                      </button>
                    </form>
                  {% endif %}
                  {% if task.can_child_cancel %}
                    <form method="post" class="icon-form" data-confirm="Kas soovid ülesande '{{ task.name }}' tühistada?">
                      {% csrf_token %}
                      <input type="hidden" name="action" value="cancel">
                      <input type="hidden" name="task_id" value="{{ task.id }}">
                      <button type="submit" class="icon-button" aria-label="Tühista {{ task.name }}">
                        <svg viewBox="0 0 24 24" aria-hidden="true">
                          <line x1="18" y1="6" x2="6" y2="18"></line>
                          <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                      </button>
                    </form>
                  {% endif %}
                  {% if is_parent %}
                    <button
                      type="button"
                      class="icon-button"
                      data-open-task-modal="edit"
                      data-task-id="{{ task.id }}"
                      data-task-name="{{ task.name|escape }}"
                      data-task-description="{{ task.description|default_if_none:''|escape }}"
                      data-task-assigned="{{ task.assigned_to_id|default:'' }}"
                      data-task-points="{{ task.points }}"
                      data-task-priority="{{ task.priority }}"
                      data-task-due="{{ task.due_date|date:'Y-m-d'|default_if_none:'' }}"
                      data-task-recurring-frequency="{% if task.recurrences.exists %}{{ task.recurrences.first.frequency }}{% endif %}"
                      data-task-recurring-end-date="{% if task.recurrences.exists %}{{ task.recurrences.first.end_date|date:'Y-m-d'|default_if_none:'' }}{% endif %}"
                    >
                      <svg viewBox="0 0 24 24" aria-hidden="true">
                        <path d="M12 20h9"></path>
                        <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4Z"></path>
                      </svg>
                    </button>
                    <form method="post" class="icon-form" data-confirm="Kas oled kindel, et soovid ülesande '{{ task.name }}' kustutada? Seda ei saa tagasi võtta.">
                      {% csrf_token %}
                      <input type="hidden" name="action" value="delete">
                      <input type="hidden" name="task_id" value="{{ task.id }}">
                      <button type="submit" class="icon-button" aria-label="Kustuta {{ task.name }}">
                        <svg viewBox="0 0 24 24" aria-hidden="true">
                          <polyline points="3 6 5 6 21 6"></polyline>
                          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                          <line x1="10" y1="11" x2="10" y2="17"></line>
                          <line x1="14" y1="11" x2="14" y2="17"></line>
                        </svg>
                      </button>
                    </form>
                  {% endif %}
                </div>
              </article>
            {% endfor %}
          {% else %}
            <p class="empty-state full-row">Aktiivseid ülesandeid pole. Võta hetk puhkuseks!</p>
          {% endif %}
        </div>
      </section>

      <section class="task-section">
        <header class="list-section-header">
          <span class="list-section-icon accent-icon" aria-hidden="true"></span>
          <h2>Ootab kinnitust</h2>
        </header>
        <div class="task-grid">
          {% if pending_tasks %}
            {% for task in pending_tasks %}
              <article class="task-card awaiting priority-{{ task.priority }}">
                <div class="task-card-header">
                  <div>
                    <h3 class="task-name">
                      <svg class="task-status-icon completed-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-label="Lõpetatud">
                        <polyline points="20 6 9 17 4 12"></polyline>
                      </svg>
                      {{ task.name }}
                    </h3>
                    <p class="task-assigned">
                      {% if is_child %}
                        {% if task.assigned_to == user %}
                          Määratud: Sinule
                        {% elif task.assigned_to %}
                          Määratud: {% if task.assigned_to.first_name %}{{ task.assigned_to.first_name }}{% if task.assigned_to.username %} @{{ task.assigned_to.username }}{% endif %}{% else %}{{ task.assigned_to.display_name }}{% endif %}
                        {% else %}
                          Määratud: Kõigile
                        {% endif %}
                      {% else %}
                        {% if task.assigned_to %}
                          Määratud: {% if task.assigned_to.first_name %}{{ task.assigned_to.first_name }}{% if task.assigned_to.username %} @{{ task.assigned_to.username }}{% endif %}{% else %}{{ task.assigned_to.display_name }}{% endif %}
                        {% else %}
                          Määratud: Kõigile
                        {% endif %}
                      {% endif %}
                    </p>
                    {% if task.description %}
                      <p class="task-description">{{ task.description }}</p>
                    {% endif %}
                  </div>
                  <span class="task-points points-chip">
                    <span class="points-value">{{ task.points }}</span>
                    <span class="points-label">pts</span>
                  </span>
                </div>
                <div class="task-meta">
                  <div class="task-meta-item">
                    <svg class="task-meta-icon" viewBox="0 0 24 24" aria-hidden="true">
                      <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
                    </svg>
                    <span class="task-meta-label">{% if task.priority == 0 %}Madal{% elif task.priority == 1 %}Keskmine{% else %}Kõrge{% endif %}</span>
                  </div>
                  <div class="task-meta-item">
                    <svg class="task-meta-icon" viewBox="0 0 24 24" aria-hidden="true">
                      <circle cx="12" cy="12" r="10"></circle>
                      <polyline points="12 6 12 12 16 14"></polyline>
                    </svg>
                    <span class="task-meta-label">Lõpetas {% if task.completed_by.first_name %}{{ task.completed_by.first_name }}{% if task.completed_by.username %} @{{ task.completed_by.username }}{% endif %}{% else %}{{ task.completed_by.display_name }}{% endif %} {{ task.completed_at|date:"j.m.Y H:i" }}</span>
                  </div>
                  {% if task.due_date %}
                    <div class="task-meta-item">
                      <svg class="task-meta-icon" viewBox="0 0 24 24" aria-hidden="true">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                      </svg>
                      <span class="task-meta-label">{{ task.due_date|date:"j.m" }}</span>
                    </div>
                  {% endif %}
                </div>
                <div class="task-actions">
                  {% if is_parent %}
                    <form method="post" class="icon-form" data-confirm="Kas oled kindel, et soovid ülesande '{{ task.name }}' kinnitada? See annab {{ task.points }} punkti ja märgib ülesande kinnitatud.">
                      {% csrf_token %}
                      <input type="hidden" name="action" value="approve">
                      <input type="hidden" name="task_id" value="{{ task.id }}">
                      <button type="submit" class="icon-button success" aria-label="Kinnita {{ task.name }}">
                        <svg viewBox="0 0 24 24" aria-hidden="true">
                          <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                      </button>
                    </form>
                    <form method="post" class="icon-form" data-confirm="Kas soovid ülesande '{{ task.name }}' tagasi lükata? See eemaldab täitmise staatuse.">
                      {% csrf_token %}
                      <input type="hidden" name="action" value="reopen">
                      <input type="hidden" name="task_id" value="{{ task.id }}">
                      <button type="submit" class="icon-button" aria-label="Ava {{ task.name }} uuesti">
                        <svg viewBox="0 0 24 24" aria-hidden="true">
                          <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path>
                          <path d="M21 3v5h-5"></path>
                          <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path>
                          <path d="M3 21v-5h5"></path>
                        </svg>
                      </button>
                    </form>
                  {% endif %}
                </div>
              </article>
            {% endfor %}
          {% else %}
            <p class="empty-state full-row">Kinnitust ootavaid ülesandeid pole.</p>
          {% endif %}
        </div>
      </section>

      <section class="task-section">
        <header class="list-section-header">
          <span class="list-section-icon cart-icon" aria-hidden="true"></span>
          <h2>Kinnitatud ülesanded</h2>
        </header>
        <div class="task-grid">
          {% if approved_tasks %}
            {% for task in approved_tasks %}
              <article class="task-card approved priority-{{ task.priority }}">
                <div class="task-card-header">
                  <div>
                    <h3 class="task-name">
                      <svg class="task-status-icon approved-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-label="Kinnitatud">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                        <polyline points="22 4 12 14.01 9 11.01"></polyline>
                      </svg>
                      {{ task.name }}
                    </h3>
                    <p class="task-assigned">
                      {% with winner=task.assigned_to|default:task.completed_by %}
                        {% if is_child %}
                          {% if winner == user %}
                            Punktid teenis: Sina
                          {% else %}
                            Punktid teenis: {% if winner.first_name %}{{ winner.first_name }}{% if winner.username %} @{{ winner.username }}{% endif %}{% else %}{{ winner.display_name }}{% endif %}
                          {% endif %}
                        {% else %}
                          Punktid teenis: {% if winner.first_name %}{{ winner.first_name }}{% if winner.username %} @{{ winner.username }}{% endif %}{% else %}{{ winner.display_name }}{% endif %}
                        {% endif %}
                      {% endwith %}
                    </p>
                    {% if task.description %}
                      <p class="task-description">{{ task.description }}</p>
                    {% endif %}
                  </div>
                  <span class="task-points points-chip">
                    <span class="points-value">{{ task.points }}</span>
                    <span class="points-label">pts</span>
                  </span>
                </div>
                <div class="task-meta">
                  <div class="task-meta-item">
                    <svg class="task-meta-icon" viewBox="0 0 24 24" aria-hidden="true">
                      <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
                    </svg>
                    <span class="task-meta-label">{% if task.priority == 0 %}Madal{% elif task.priority == 1 %}Keskmine{% else %}Kõrge{% endif %}</span>
                  </div>
                  <div class="task-meta-item">
                    <svg class="task-meta-icon" viewBox="0 0 24 24" aria-hidden="true">
                      <circle cx="12" cy="12" r="10"></circle>
                      <polyline points="12 6 12 12 16 14"></polyline>
                    </svg>
                    <span class="task-meta-label">Kinnitas {% if task.approved_by.first_name %}{{ task.approved_by.first_name }}{% if task.approved_by.username %} @{{ task.approved_by.username }}{% endif %}{% else %}{{ task.approved_by.display_name }}{% endif %} {{ task.approved_at|date:"j.m.Y H:i" }}</span>
                  </div>
                  {% if task.due_date %}
                    <div class="task-meta-item">
                      <svg class="task-meta-icon" viewBox="0 0 24 24" aria-hidden="true">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                      </svg>
                      <span class="task-meta-label">{{ task.due_date|date:"j.m" }}</span>
                    </div>
                  {% endif %}
                </div>
                {% if is_parent %}
                  <div class="task-actions">
                    <form method="post" class="icon-form" data-confirm="Kas oled kindel, et soovid ülesande '{{ task.name }}' kustutada? Seda ei saa tagasi võtta.">
                      {% csrf_token %}
                      <input type="hidden" name="action" value="delete">
                      <input type="hidden" name="task_id" value="{{ task.id }}">
                      <button type="submit" class="icon-button" aria-label="Kustuta {{ task.name }}">
                        <svg viewBox="0 0 24 24" aria-hidden="true">
                          <polyline points="3 6 5 6 21 6"></polyline>
                          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                          <line x1="10" y1="11" x2="10" y2="17"></line>
                          <line x1="14" y1="11" x2="14" y2="17"></line>
                        </svg>
                      </button>
                    </form>
                  </div>
                {% endif %}
              </article>
            {% endfor %}
          {% else %}
            <p class="empty-state full-row">Kinnitatud ülesandeid veel pole. Jätkake samas vaimus!</p>
          {% endif %}
        </div>
      </section>
    {% endif %}
  </div>

  <!-- Custom Confirmation Modal -->
  <div class="confirm-modal" id="confirm-modal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="confirm-modal-overlay"></div>
    <div class="confirm-modal-content">
      <h3 class="confirm-modal-title" id="confirm-modal-title">Kinnita toiming</h3>
      <p class="confirm-modal-message" id="confirm-modal-message"></p>
      <div class="confirm-modal-actions">
        <button type="button" class="confirm-modal-cancel" id="confirm-modal-cancel">Tühista</button>
        <button type="button" class="confirm-modal-confirm" id="confirm-modal-confirm">Kinnita</button>
      </div>
    </div>
  </div>

  {% if is_parent %}
    <div class="task-modal" id="task-modal" aria-hidden="true" role="dialog" aria-modal="true">
      <div class="task-modal-overlay" data-close-modal></div>
      <div class="task-modal-content">
        <button type="button" class="task-modal-close" data-close-modal aria-label="Sulge ülesande vorm">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
        <h2 class="task-modal-title" data-modal-title>Lisa ülesanne</h2>
        <form method="post" class="task-modal-form" id="task-modal-form">
          {% csrf_token %}
          <input type="hidden" name="action" value="create">
          <input type="hidden" name="task_id" value="">
          <label>
            <span>Ülesande nimi</span>
            <input type="text" name="name" placeholder="Hommikused tegemised" required>
          </label>
          <label>
            <span>Kirjeldus</span>
            <textarea name="description" rows="3" placeholder="Lisa täpsustused või meeldetuletused..."></textarea>
          </label>
          <label>
            <span>Määra kasutajale</span>
            <select name="assigned_to">
              <option value="">Avatud ülesanne (ükskõik milline laps)</option>
              {% for member in family_members %}
                <option value="{{ member.id }}">
                  {{ member.display_name }}
                  {% if member.role %}
                    ({{ member.get_role_display }})
                  {% endif %}
                </option>
              {% endfor %}
            </select>
          </label>
          <div class="task-modal-grid">
            <label>
              <span>Punktid</span>
              <input type="number" name="points" min="0" value="25">
            </label>
            <label>
              <span>Tähtsus</span>
              <select name="priority">
                <option value="0">Madal</option>
                <option value="1">Keskmine</option>
                <option value="2">Kõrge</option>
              </select>
            </label>
            <label>
              <span>Tähtaeg</span>
              <input type="date" name="due_date">
            </label>
          </div>
          <div class="task-modal-recurring">
            <label>
              <span>Korduv ülesanne</span>
              <select name="recurring_frequency" id="recurring-frequency">
                <option value="">Ei kordu</option>
                <option value="daily">Igapäevaselt</option>
                <option value="weekly">Nädalaselt</option>
                <option value="monthly">Kuus</option>
              </select>
            </label>
            <label id="recurring-end-date-label" style="display: none;">
              <span>Lõppkuupäev (valikuline)</span>
              <input type="date" name="recurring_end_date" id="recurring-end-date">
            </label>
          </div>
          <div class="form-actions">
            <button type="submit" class="primary-button">
              <span aria-hidden="true" data-submit-icon>+</span>
              <span data-submit-label>Salvesta ülesanne</span>
            </button>
          </div>
        </form>
      </div>
    </div>
  {% endif %}

  {% if is_parent %}
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const modal = document.getElementById('task-modal');
        if (!modal) return;

        const form = document.getElementById('task-modal-form');
        const actionInput = form.querySelector('input[name="action"]');
        const idInput = form.querySelector('input[name="task_id"]');
        const nameInput = form.querySelector('input[name="name"]');
        const descriptionInput = form.querySelector('textarea[name="description"]');
        const assignedSelect = form.querySelector('select[name="assigned_to"]');
        const pointsInput = form.querySelector('input[name="points"]');
        const prioritySelect = form.querySelector('select[name="priority"]');
        const dueInput = form.querySelector('input[name="due_date"]');
        const recurringFrequencySelect = form.querySelector('select[name="recurring_frequency"]');
        const recurringEndDateInput = form.querySelector('input[name="recurring_end_date"]');
        const recurringEndDateLabel = document.getElementById('recurring-end-date-label');
        const titleEl = modal.querySelector('[data-modal-title]');
        const submitLabel = modal.querySelector('[data-submit-label]');
        const submitIcon = modal.querySelector('[data-submit-icon]');

        submitIcon.dataset.createIcon = '+';
        submitIcon.dataset.editIcon = '✔';

        function openModal(mode, data = {}) {
          modal.classList.add('is-visible');
          document.body.classList.add('modal-open');
          form.reset();
          // Ensure modal is visible by scrolling viewport to top
          setTimeout(() => {
            window.scrollTo({ top: 0, behavior: 'smooth' });
            const modalContent = modal.querySelector('.task-modal-content');
            if (modalContent) {
              modalContent.scrollTop = 0;
            }
          }, 10);

          if (mode === 'create') {
            actionInput.value = 'create';
            idInput.value = '';
            titleEl.textContent = 'Lisa ülesanne';
            submitLabel.textContent = 'Salvesta ülesanne';
            submitIcon.textContent = submitIcon.dataset.createIcon || '+';
            assignedSelect.value = '';
          } else {
            actionInput.value = 'update';
            idInput.value = data.id || '';
            titleEl.textContent = 'Muuda ülesannet';
            submitLabel.textContent = 'Uuenda ülesannet';
            submitIcon.textContent = submitIcon.dataset.editIcon || '✔';

            nameInput.value = data.name || '';
            descriptionInput.value = data.description || '';
            pointsInput.value = data.points || 0;
            prioritySelect.value = data.priority ?? '0';
            dueInput.value = data.due || '';

            assignedSelect.value = '';
            if (data.assigned && assignedSelect.querySelector(`option[value="${data.assigned}"]`)) {
              assignedSelect.value = data.assigned;
            }
            
            // Set recurrence fields
            recurringFrequencySelect.value = data.recurringFrequency || '';
            recurringEndDateInput.value = data.recurringEndDate || '';
            updateRecurringEndDateVisibility();
          }
        }
        
        function updateRecurringEndDateVisibility() {
          if (recurringFrequencySelect.value) {
            recurringEndDateLabel.style.display = 'block';
          } else {
            recurringEndDateLabel.style.display = 'none';
            recurringEndDateInput.value = '';
          }
        }
        
        recurringFrequencySelect.addEventListener('change', updateRecurringEndDateVisibility);

        function closeModal() {
          modal.classList.remove('is-visible');
          document.body.classList.remove('modal-open');
        }

        document.querySelectorAll('[data-open-task-modal="create"]').forEach((button) => {
          button.addEventListener('click', () => openModal('create'));
        });

        document.querySelectorAll('[data-open-task-modal="edit"]').forEach((button) => {
          button.addEventListener('click', () => {
            openModal('edit', {
              id: button.dataset.taskId,
              name: button.dataset.taskName,
              description: button.dataset.taskDescription,
              assigned: button.dataset.taskAssigned,
              points: button.dataset.taskPoints,
              priority: button.dataset.taskPriority,
              due: button.dataset.taskDue,
              recurringFrequency: button.dataset.taskRecurringFrequency || '',
              recurringEndDate: button.dataset.taskRecurringEndDate || '',
            });
          });
        });

        modal.querySelectorAll('[data-close-modal]').forEach((el) => {
          el.addEventListener('click', closeModal);
        });

        modal.addEventListener('click', (event) => {
          if (event.target === modal) {
            closeModal();
          }
        });

        document.addEventListener('keydown', (event) => {
          if (event.key === 'Escape' && modal.classList.contains('is-visible')) {
            closeModal();
          }
        });
      });

    </script>
  {% endif %}

  <script>
    // Custom confirmation modal - available for all users
    document.addEventListener('DOMContentLoaded', function () {
      const confirmModal = document.getElementById('confirm-modal');
      if (!confirmModal) return;
      
      const confirmTitle = document.getElementById('confirm-modal-title');
      const confirmMessage = document.getElementById('confirm-modal-message');
      const confirmButton = document.getElementById('confirm-modal-confirm');
      const cancelButton = document.getElementById('confirm-modal-cancel');
      const confirmOverlay = confirmModal.querySelector('.confirm-modal-overlay');
      
      if (!confirmTitle || !confirmMessage || !confirmButton || !cancelButton || !confirmOverlay) {
        console.error('Confirmation modal elements not found');
        return;
      }
      
      let confirmResolve = null;
      let pendingForm = null;
      let formSubmitHandler = null;

      function showConfirm(title, message) {
        return new Promise((resolve) => {
          confirmTitle.textContent = title;
          confirmMessage.textContent = message;
          // Prevent body scroll and ensure modal is visible
          document.body.classList.add('modal-open');
          confirmModal.classList.add('is-visible');
          // Scroll window to top to ensure modal is visible
          setTimeout(() => {
            window.scrollTo({ top: 0, behavior: 'smooth' });
            const modalContent = confirmModal.querySelector('.confirm-modal-content');
            if (modalContent) {
              modalContent.scrollTop = 0;
            }
          }, 10);
          confirmResolve = resolve;
        });
      }

      function closeConfirm(result) {
        confirmModal.classList.remove('is-visible');
        document.body.classList.remove('modal-open');
        if (confirmResolve) {
          confirmResolve(result);
          confirmResolve = null;
        }
        
        // If confirmed, submit the pending form
        if (result && pendingForm) {
          // Remove the data-confirm attribute so the form submits normally
          pendingForm.removeAttribute('data-confirm');
          
          // Remove the event listener temporarily
          if (formSubmitHandler) {
            pendingForm.removeEventListener('submit', formSubmitHandler);
          }
          
          // Submit the form directly (this bypasses event listeners)
          if (pendingForm.requestSubmit) {
            // Modern browsers - requestSubmit respects validation but allows submission
            pendingForm.requestSubmit();
          } else {
            // Fallback - create a submit event
            const submitEvent = new Event('submit', {
              bubbles: true,
              cancelable: true
            });
            const submitted = pendingForm.dispatchEvent(submitEvent);
            
            // If event wasn't prevented, submit directly
            if (submitted) {
              pendingForm.submit();
            }
          }
          
          // Re-add the data-confirm attribute and listener after a short delay
          setTimeout(() => {
            if (pendingForm && formSubmitHandler) {
              pendingForm.setAttribute('data-confirm', pendingForm.dataset.originalConfirm || '');
              pendingForm.addEventListener('submit', formSubmitHandler);
            }
          }, 100);
        }
        
        pendingForm = null;
        formSubmitHandler = null;
      }

      confirmButton.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        closeConfirm(true);
      });
      
      cancelButton.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        closeConfirm(false);
      });
      
      confirmOverlay.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        closeConfirm(false);
      });

      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && confirmModal.classList.contains('is-visible')) {
          closeConfirm(false);
        }
      });

      // Handle forms with data-confirm attribute
      document.querySelectorAll('form[data-confirm]').forEach((form) => {
        // Store original confirm message
        form.dataset.originalConfirm = form.getAttribute('data-confirm');
        
        const submitHandler = async function (e) {
          // Skip if form doesn't have data-confirm attribute (means it was removed for submission)
          if (!form.hasAttribute('data-confirm')) {
            return;
          }
          
          e.preventDefault();
          e.stopPropagation();
          const message = form.getAttribute('data-confirm');
          const action = form.querySelector('input[name="action"]')?.value || 'toiming';
          let title = 'Kinnita toiming';
          
          if (action === 'delete') {
            title = 'Kinnita kustutamine';
          } else if (action === 'reopen') {
            title = 'Kinnita tagasilükkamine';
          } else if (action === 'complete') {
            title = 'Kinnita täitmine';
          } else if (action === 'approve') {
            title = 'Kinnita ülesanne';
          }
          
          pendingForm = form;
          formSubmitHandler = submitHandler;
          const confirmed = await showConfirm(title, message);
        };
        
        form.addEventListener('submit', submitHandler);
      });
    });
  </script>

  {% if is_parent %}
    <script>
      // Help modal functionality
      document.addEventListener('DOMContentLoaded', function () {
        const helpButton = document.getElementById('task-help-button');
        const helpModal = document.getElementById('task-help-modal');
        const closeButtons = document.querySelectorAll('[data-close-help-modal]');
        
        if (!helpButton || !helpModal) return;
        
        function openHelpModal() {
          helpModal.setAttribute('aria-hidden', 'false');
          helpModal.classList.add('is-visible');
          document.body.classList.add('modal-open');
        }
        
        function closeHelpModal() {
          helpModal.setAttribute('aria-hidden', 'true');
          helpModal.classList.remove('is-visible');
          document.body.classList.remove('modal-open');
        }
        
        helpButton.addEventListener('click', openHelpModal);
        closeButtons.forEach(btn => btn.addEventListener('click', closeHelpModal));
        
        helpModal.addEventListener('click', (e) => {
          if (e.target === helpModal || e.target.classList.contains('task-help-modal-overlay')) {
            closeHelpModal();
          }
        });
        
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && helpModal.classList.contains('is-visible')) {
            closeHelpModal();
          }
        });
      });
    </script>
    
    <script>
      // Quick add form enhancements with autocomplete
      document.addEventListener('DOMContentLoaded', function () {
        const quickAddForm = document.getElementById('quick-add-task-form');
        const quickAddInput = document.getElementById('quick-task-input');
        const autocompleteDropdown = document.getElementById('autocomplete-dropdown');
        
        if (!quickAddForm || !quickAddInput) return;
        
        // Family members data for autocomplete
        const familyMembers = {{ family_members_data|default:"[]" }};
        let selectedIndex = -1;
        let filteredMembers = [];
        
        // Auto-focus on desktop (not mobile to prevent keyboard popup)
        if (window.innerWidth > 768) {
          quickAddInput.focus();
        }
        
        // Autocomplete functionality
        function showAutocomplete(matches) {
          if (!matches || matches.length === 0) {
            autocompleteDropdown.innerHTML = '';
            autocompleteDropdown.classList.remove('is-visible');
            return;
          }
          
          filteredMembers = matches;
          selectedIndex = -1;
          
          autocompleteDropdown.innerHTML = matches.map((member, index) => {
            return `<div class="autocomplete-item" data-index="${index}" role="option" tabindex="0">
              <span class="autocomplete-name">${member.display_text}</span>
            </div>`;
          }).join('');
          
          autocompleteDropdown.classList.add('is-visible');
          
          // Add click handlers
          autocompleteDropdown.querySelectorAll('.autocomplete-item').forEach((item, index) => {
            item.addEventListener('click', () => selectMember(matches[index]));
            item.addEventListener('mousedown', (e) => e.preventDefault()); // Prevent input blur
          });
        }
        
        function hideAutocomplete() {
          autocompleteDropdown.classList.remove('is-visible');
          selectedIndex = -1;
        }
        
        function selectMember(member) {
          const inputValue = quickAddInput.value;
          const cursorPos = quickAddInput.selectionStart;
          
          // Find the @ mention position
          let mentionStart = inputValue.lastIndexOf('@', cursorPos - 1);
          if (mentionStart === -1) {
            // No @ found, insert @name at cursor
            const before = inputValue.substring(0, cursorPos);
            const after = inputValue.substring(cursorPos);
            quickAddInput.value = before + '@' + (member.first_name || member.username) + ' ' + after;
            quickAddInput.focus();
            const newPos = cursorPos + 1 + (member.first_name || member.username).length + 1;
            quickAddInput.setSelectionRange(newPos, newPos);
          } else {
            // Replace the mention
            const before = inputValue.substring(0, mentionStart + 1);
            const afterMatch = inputValue.substring(mentionStart + 1).match(/^(\w*)\s*/);
            const after = afterMatch ? inputValue.substring(mentionStart + 1 + afterMatch[0].length) : inputValue.substring(mentionStart + 1);
            quickAddInput.value = before + (member.first_name || member.username) + ' ' + after;
            quickAddInput.focus();
            const newPos = mentionStart + 1 + (member.first_name || member.username).length + 1;
            quickAddInput.setSelectionRange(newPos, newPos);
          }
          
          hideAutocomplete();
        }
        
        function filterMembers(query) {
          if (!query || query.length < 1) {
            return [];
          }
          
          const lowerQuery = query.toLowerCase();
          return familyMembers.filter(member => {
            return member.search_text.includes(lowerQuery) ||
                   (member.first_name && member.first_name.toLowerCase().includes(lowerQuery)) ||
                   (member.username && member.username.toLowerCase().includes(lowerQuery));
          }).slice(0, 5); // Limit to 5 results
        }
        
        // Handle input for autocomplete
        quickAddInput.addEventListener('input', function (e) {
          const value = this.value;
          const cursorPos = this.selectionStart;
          
          // Find if we're typing after an @
          const textBeforeCursor = value.substring(0, cursorPos);
          const mentionMatch = textBeforeCursor.match(/@(\w*)$/);
          
          if (mentionMatch) {
            const query = mentionMatch[1];
            const matches = filterMembers(query);
            showAutocomplete(matches);
          } else {
            hideAutocomplete();
          }
        });
        
        // Handle keyboard navigation
        quickAddInput.addEventListener('keydown', function (e) {
          if (autocompleteDropdown.classList.contains('is-visible') && filteredMembers.length > 0) {
            if (e.key === 'ArrowDown') {
              e.preventDefault();
              selectedIndex = Math.min(selectedIndex + 1, filteredMembers.length - 1);
              updateSelectedItem();
            } else if (e.key === 'ArrowUp') {
              e.preventDefault();
              selectedIndex = Math.max(selectedIndex - 1, -1);
              updateSelectedItem();
            } else if (e.key === 'Enter' && selectedIndex >= 0) {
              e.preventDefault();
              selectMember(filteredMembers[selectedIndex]);
            } else if (e.key === 'Escape') {
              hideAutocomplete();
            }
          } else if (e.key === 'Enter' && !e.shiftKey && !e.ctrlKey && !e.metaKey) {
            e.preventDefault();
            quickAddForm.submit();
          } else if (e.key === 'Escape') {
            this.value = '';
            this.blur();
            hideAutocomplete();
          }
        });
        
        function updateSelectedItem() {
          const items = autocompleteDropdown.querySelectorAll('.autocomplete-item');
          items.forEach((item, index) => {
            item.classList.toggle('is-selected', index === selectedIndex);
          });
        }
        
        // Hide autocomplete when clicking outside
        document.addEventListener('click', function (e) {
          if (!quickAddInput.contains(e.target) && !autocompleteDropdown.contains(e.target)) {
            hideAutocomplete();
          }
        });
        
        // Prevent zoom on iOS when focusing input
        if (/iPhone|iPad|iPod/.test(navigator.userAgent)) {
          quickAddInput.addEventListener('focus', function () {
            const viewport = document.querySelector('meta[name="viewport"]');
            if (viewport) {
              viewport.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no');
            }
          });
          
          quickAddInput.addEventListener('blur', function () {
            const viewport = document.querySelector('meta[name="viewport"]');
            if (viewport) {
              viewport.setAttribute('content', 'width=device-width, initial-scale=1.0');
            }
          });
        }
        
        // Clear input after successful submission (form will redirect, but just in case)
        quickAddForm.addEventListener('submit', function () {
          hideAutocomplete();
          // Input will be cleared on redirect, but we can clear it here too
          setTimeout(function () {
            quickAddInput.value = '';
          }, 100);
        });
      });
    </script>
  {% endif %}
{% endblock %}

