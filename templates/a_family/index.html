{% extends "base.html" %}

{% block title %}Perekond | Perekas{% endblock %}

{% block nav_family_active %} active{% endblock %}

{% block content %}
  <div class="page-container">
    <section class="page-header">
      <div>
        <h1 class="page-title">{{ family.name }}</h1>
        <p class="page-subtitle">Halda pereliikmeid ja seadeid ühest kohast.</p>
      </div>
    </section>

    <section class="family-invite-section">
      <div class="invite-code-card">
        <div class="invite-code-header">
          <div class="invite-code-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
              <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
            </svg>
          </div>
          <div>
            <h2>Perekonna kutsekood</h2>
            <p>Jaga seda koodi pereliikmetega, et nad saaksid liituda.</p>
          </div>
        </div>
        <div class="invite-code-display">
          <div class="invite-code-value" id="inviteCode">{{ family.join_code }}</div>
          <button type="button" class="btn btn-ghost" onclick="copyInviteCode()" id="copyButton">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 18px; height: 18px;">
              <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
              <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
            <span id="copyButtonText">Kopeeri</span>
          </button>
        </div>
      </div>
    </section>

    <section class="family-members-section">
      <div class="members-card">
        <header class="card-header">
          <div class="card-title-wrap">
            <span class="card-icon icon-purple"></span>
            <h2>Pereliikmed</h2>
          </div>
        </header>
        {% if members %}
          <div class="members-grid">
            {% for member in members %}
              <div class="member-card {% if is_parent and member.role == 'child' %}member-card-clickable{% endif %}" {% if is_parent and member.role == 'child' %}data-child-id="{{ member.id }}" onclick="openChildModal({{ member.id }})"{% endif %}>
                <div class="member-header">
                  <div class="member-avatar">{{ member.display_name|slice:":2"|upper }}</div>
                  <div>
                    <h3>{{ member.display_name }}</h3>
                    <p>{{ member.points }} punkti · {{ member.get_role_display }}</p>
                    {% if member == family.owner %}
                      <span class="member-badge">Pere looja</span>
                    {% endif %}
                  </div>
                </div>
                {% if is_owner and member != family.owner %}
                  <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                    {% if is_parent and member.role == 'child' %}
                      <button type="button" class="btn btn-ghost" onclick="event.stopPropagation(); openChildModal({{ member.id }});" style="flex: 1;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                          <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                          <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                        </svg>
                        Halda
                      </button>
                    {% endif %}
                    <form method="post" action="{% url 'a_family:remove_member' member.id %}" style="{% if is_parent and member.role == 'child' %}flex: 1;{% endif %}" data-confirm="Kas soovid {{ member.display_name }} perest eemaldada? Liige kaotab juurdepääsu pere andmetele, kuid tema konto jääb alles.">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-ghost" onclick="event.stopPropagation();" style="color: rgba(239, 68, 68, 0.9); border-color: rgba(239, 68, 68, 0.3); width: 100%;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                          <path d="M3 6h18"></path>
                          <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                          <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                        </svg>
                        Eemalda
                      </button>
                    </form>
                  </div>
                {% endif %}
              </div>
            {% endfor %}
          </div>
        {% else %}
          <p class="empty-state">Pereliikmeid pole veel lisatud.</p>
        {% endif %}
      </div>
    </section>
  </div>

  <!-- Child Account Management Modal -->
  {% if is_parent %}
  <div id="childModal" class="child-modal-overlay" style="display: none;" onclick="closeChildModal(event)">
    <div class="child-modal-content" onclick="event.stopPropagation();">
      <div class="child-modal-header">
        <h2>Lapse konto haldamine</h2>
        <button type="button" class="child-modal-close" onclick="closeChildModal()" aria-label="Sulge">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="child-modal-body">
        <form method="post" id="childAccountForm" action="">
          {% csrf_token %}
          <input type="hidden" name="form_type" value="child_account">
          <input type="hidden" name="child_id" id="childIdInput">
          
          <div class="form-grid form-grid-single">
            <label class="form-field">
              <span class="field-label">Kasutajanimi</span>
              <input type="text" name="username" id="childUsername" required>
            </label>
            <label class="form-field">
              <span class="field-label">Eesnimi</span>
              <input type="text" name="first_name" id="childFirstName" required>
            </label>
            <label class="form-field">
              <span class="field-label">Perekonnanimi</span>
              <input type="text" name="last_name" id="childLastName" required>
            </label>
            <label class="form-field">
              <span class="field-label">Sünniaeg</span>
              <input type="date" name="birthdate" id="childBirthdate" max="{{ today|date:'Y-m-d' }}">
            </label>
            <label class="form-field">
              <span class="field-label">E-posti aadress</span>
              <input type="email" name="email" id="childEmail" placeholder="Lapsel ei ole e-posti (valikuline)">
              <span class="field-hint">Kui e-posti lisad või muudad, saadetakse kinnituse kiri.</span>
            </label>
            <label class="form-field">
              <span class="field-label">Uus parool</span>
              <input type="password" name="new_password" id="childPassword" placeholder="Jäta tühjaks, et mitte muuta">
              <span class="field-hint">Sisesta uus parool, kui laps unustas parooli. Vähemalt 8 märki, 1 number ja suurtäht.</span>
            </label>
          </div>
          
          <div class="form-actions">
            <button type="submit" class="btn btn-primary">Salvesta muudatused</button>
            <button type="button" class="btn btn-ghost" onclick="closeChildModal()">Loobu</button>
          </div>
        </form>
        
        <!-- Child Account Deletion -->
        <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid rgba(239, 68, 68, 0.2);">
          <div style="display: flex; align-items: center; justify-content: space-between; gap: 1rem;">
            <div style="flex: 1;">
              <h3 style="margin: 0 0 0.25rem; font-size: 1rem; font-weight: 600; color: rgba(239, 68, 68, 0.95);">Kustuta lapse konto</h3>
              <p style="margin: 0; color: var(--color-text-secondary); font-size: 0.875rem;">Konto kustutamine on pöördumatu. Kõik andmed kustutatakse jäädavalt.</p>
            </div>
            <form method="post" action="{% url 'a_family:delete_child_account' %}" style="margin: 0; flex-shrink: 0;" id="deleteChildForm" data-confirm="Kas oled kindel, et soovid selle lapse konto kustutada? Seda ei saa tagasi võtta ja kõik lapse andmed kustutatakse jäädavalt.">
              {% csrf_token %}
              <input type="hidden" name="action" value="delete">
              <input type="hidden" name="child_id" id="deleteChildIdInput">
              <button type="submit" class="btn" style="padding: 0.625rem 1.25rem; background: rgba(239, 68, 68, 0.15); border-color: rgba(239, 68, 68, 0.4); color: rgba(239, 68, 68, 0.95); font-size: 0.875rem; white-space: nowrap;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px; margin-right: 0.5rem;">
                  <path d="M3 6h18"></path>
                  <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                  <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                </svg>
                Kustuta konto
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Custom Confirmation Modal -->
  <div class="confirm-modal" id="confirm-modal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="confirm-modal-overlay"></div>
    <div class="confirm-modal-content">
      <h3 class="confirm-modal-title" id="confirm-modal-title">Kinnita toiming</h3>
      <p class="confirm-modal-message" id="confirm-modal-message"></p>
      <div class="confirm-modal-actions">
        <button type="button" class="confirm-modal-cancel" id="confirm-modal-cancel">Tühista</button>
        <button type="button" class="confirm-modal-confirm" id="confirm-modal-confirm">Kinnita</button>
      </div>
    </div>
  </div>

  <style>
    .family-invite-section {
      margin-bottom: 2.5rem;
    }

    .invite-code-card {
      background: linear-gradient(135deg, rgba(12, 18, 35, 0.95), rgba(16, 24, 46, 0.9));
      border: 1px solid rgba(59, 72, 99, 0.35);
      border-radius: var(--radius-md);
      padding: 2rem;
      box-shadow: var(--shadow-soft);
    }

    .invite-code-header {
      display: flex;
      align-items: flex-start;
      gap: 1.25rem;
      margin-bottom: 1.75rem;
    }

    .invite-code-icon {
      width: 52px;
      height: 52px;
      border-radius: 16px;
      background: linear-gradient(135deg, rgba(139, 92, 246, 0.25), rgba(59, 130, 246, 0.35));
      display: grid;
      place-items: center;
      color: #fff;
      flex-shrink: 0;
    }

    .invite-code-icon svg {
      width: 28px;
      height: 28px;
      stroke: currentColor;
      stroke-width: 1.8;
      fill: none;
    }

    .invite-code-header h2 {
      margin: 0 0 0.5rem;
      font-size: 1.4rem;
      font-weight: 600;
      color: #f8fafc;
      letter-spacing: -0.01em;
    }

    .invite-code-header p {
      margin: 0;
      color: var(--color-text-secondary);
      font-size: 0.95rem;
      line-height: 1.5;
    }

    .invite-code-display {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1.5rem;
      background: rgba(3, 8, 22, 0.6);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: var(--radius-sm);
    }

    .invite-code-value {
      flex: 1;
      font-size: 2rem;
      font-weight: 700;
      letter-spacing: 0.2em;
      color: #f8fafc;
      font-family: 'Courier New', monospace;
      text-align: center;
      padding: 0.75rem;
      background: rgba(15, 23, 42, 0.5);
      border-radius: var(--radius-sm);
      border: 1px solid rgba(139, 92, 246, 0.3);
    }

    .member-badge {
      display: inline-block;
      margin-top: 0.25rem;
      padding: 0.25rem 0.6rem;
      border-radius: 999px;
      background: rgba(139, 92, 246, 0.15);
      color: var(--color-primary);
      border: 1px solid rgba(139, 92, 246, 0.25);
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    

    @media (max-width: 768px) {
      .invite-code-display {
        flex-direction: column;
      }

      .invite-code-value {
        width: 100%;
      }

      .invite-code-header {
        flex-direction: column;
        text-align: center;
      }
    }
  </style>

  <script>
    function copyInviteCode() {
      const code = document.getElementById('inviteCode').textContent;
      const button = document.getElementById('copyButton');
      const buttonText = document.getElementById('copyButtonText');
      
      navigator.clipboard.writeText(code).then(() => {
        buttonText.textContent = 'Kopeeritud!';
        button.style.background = 'rgba(34, 197, 94, 0.15)';
        button.style.borderColor = 'rgba(34, 197, 94, 0.3)';
        button.style.color = '#4ade80';
        
        setTimeout(() => {
          buttonText.textContent = 'Kopeeri';
          button.style.background = '';
          button.style.borderColor = '';
          button.style.color = '';
        }, 2000);
      }).catch(err => {
        console.error('Failed to copy:', err);
        buttonText.textContent = 'Tõrge';
        setTimeout(() => {
          buttonText.textContent = 'Kopeeri';
        }, 2000);
      });
    }
    
    {% if is_parent %}
    let childData = {};
    
    function openChildModal(childId) {
      // Fetch child data
      fetch(`/family/manage-child/${childId}/?format=json`)
        .then(response => response.json())
        .then(data => {
          childData = data;
          // Populate form
          document.getElementById('childIdInput').value = data.id;
          document.getElementById('childUsername').value = data.username || '';
          document.getElementById('childFirstName').value = data.first_name || '';
          document.getElementById('childLastName').value = data.last_name || '';
          document.getElementById('childBirthdate').value = data.birthdate || '';
          document.getElementById('childEmail').value = data.email || '';
          document.getElementById('childPassword').value = '';
          
          // Update form action
          document.getElementById('childAccountForm').action = `/family/manage-child/${childId}/`;
          
          // Update delete form child ID
          const deleteChildIdInput = document.getElementById('deleteChildIdInput');
          if (deleteChildIdInput) {
            deleteChildIdInput.value = data.id;
          }
          
          // Show modal
          const modal = document.getElementById('childModal');
          modal.style.display = 'block';
          document.body.classList.add('modal-open');
          // Scroll window to top to ensure modal is visible
          setTimeout(() => {
            window.scrollTo({ top: 0, behavior: 'smooth' });
            const modalContent = modal.querySelector('.child-modal-content');
            if (modalContent) {
              modalContent.scrollTop = 0;
            }
          }, 10);
        })
        .catch(error => {
          console.error('Error loading child data:', error);
          alert('Midagi läks valesti. Palun proovi uuesti.');
        });
    }
    
    function closeChildModal(event) {
      if (event && event.target.id !== 'childModal' && !event.target.closest('.child-modal-content')) {
        return;
      }
      const modal = document.getElementById('childModal');
      if (modal) {
        modal.style.display = 'none';
        document.body.classList.remove('modal-open');
        // Reset form
        const form = document.getElementById('childAccountForm');
        if (form) {
          form.reset();
        }
      }
    }
    
    // Close on Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        const modal = document.getElementById('childModal');
        if (modal && (modal.style.display === 'block' || modal.style.display === 'flex')) {
          closeChildModal();
        }
      }
    });
    {% endif %}

    // Custom confirmation modal
    const confirmModal = document.getElementById('confirm-modal');
    if (confirmModal) {
      const confirmTitle = document.getElementById('confirm-modal-title');
      const confirmMessage = document.getElementById('confirm-modal-message');
      const confirmButton = document.getElementById('confirm-modal-confirm');
      const cancelButton = document.getElementById('confirm-modal-cancel');
      const confirmOverlay = confirmModal.querySelector('.confirm-modal-overlay');
      
      if (confirmTitle && confirmMessage && confirmButton && cancelButton && confirmOverlay) {
        let confirmResolve = null;
        let pendingForm = null;
        let formSubmitHandler = null;

        function showConfirm(title, message) {
          return new Promise((resolve) => {
            confirmTitle.textContent = title;
            confirmMessage.textContent = message;
            document.body.classList.add('modal-open');
            confirmModal.classList.add('is-visible');
            // Scroll window to top to ensure modal is visible
            setTimeout(() => {
              window.scrollTo({ top: 0, behavior: 'smooth' });
              const modalContent = confirmModal.querySelector('.confirm-modal-content');
              if (modalContent) {
                modalContent.scrollTop = 0;
              }
            }, 10);
            confirmResolve = resolve;
          });
        }

        function closeConfirm(result) {
          confirmModal.classList.remove('is-visible');
          document.body.classList.remove('modal-open');
          if (confirmResolve) {
            confirmResolve(result);
            confirmResolve = null;
          }
          
          if (result && pendingForm) {
            pendingForm.removeAttribute('data-confirm');
            
            if (formSubmitHandler) {
              pendingForm.removeEventListener('submit', formSubmitHandler);
            }
            
            if (pendingForm.requestSubmit) {
              pendingForm.requestSubmit();
            } else {
              const submitEvent = new Event('submit', {
                bubbles: true,
                cancelable: true
              });
              const submitted = pendingForm.dispatchEvent(submitEvent);
              
              if (submitted) {
                pendingForm.submit();
              }
            }
            
            setTimeout(() => {
              if (pendingForm && formSubmitHandler) {
                pendingForm.setAttribute('data-confirm', pendingForm.dataset.originalConfirm || '');
                pendingForm.addEventListener('submit', formSubmitHandler);
              }
            }, 100);
          }
          
          pendingForm = null;
          formSubmitHandler = null;
        }

        confirmButton.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          closeConfirm(true);
        });
        
        cancelButton.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          closeConfirm(false);
        });
        
        confirmOverlay.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          closeConfirm(false);
        });

        document.addEventListener('keydown', (event) => {
          if (event.key === 'Escape' && confirmModal.classList.contains('is-visible')) {
            closeConfirm(false);
          }
        });

        // Handle forms with data-confirm attribute
        document.querySelectorAll('form[data-confirm]').forEach((form) => {
          form.dataset.originalConfirm = form.getAttribute('data-confirm');
          
          const submitHandler = async function (e) {
            if (!form.hasAttribute('data-confirm')) {
              return;
            }
            
            e.preventDefault();
            e.stopPropagation();
            
            // Close child modal if it's open (for delete child form)
            const childModal = document.getElementById('childModal');
            if (childModal && (childModal.style.display === 'block' || childModal.style.display === 'flex')) {
              childModal.style.display = 'none';
              // Wait a bit for modal close animation if any
              await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            const message = form.getAttribute('data-confirm');
            const action = form.querySelector('input[name="action"]')?.value || 'toiming';
            const formAction = form.getAttribute('action') || '';
            let title = 'Kinnita toiming';
            
            if (action === 'delete') {
              title = 'Kinnita kustutamine';
            } else if (formAction.includes('remove_member')) {
              title = 'Kinnita eemaldamine';
            }
            
            pendingForm = form;
            formSubmitHandler = submitHandler;
            await showConfirm(title, message);
          };
          
          form.addEventListener('submit', submitHandler);
        });
      }
    }
  </script>
{% endblock %}

